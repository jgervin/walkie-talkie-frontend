{"ast":null,"code":"\"use strict\";\n\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nvar __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n/**\n * @packageDocumentation\n * @module Voice\n * @publicapi\n * @internal\n */\n\nvar events_1 = require(\"events\");\n\nvar device_1 = require(\"./device\");\n\nvar errors_1 = require(\"./errors\");\n\nvar log_1 = require(\"./log\");\n\nvar icecandidate_1 = require(\"./rtc/icecandidate\");\n\nvar statsMonitor_1 = require(\"./statsMonitor\");\n\nvar util_1 = require(\"./util\");\n\nvar Backoff = require('backoff');\n\nvar C = require('./constants');\n\nvar PeerConnection = require('./rtc').PeerConnection;\n\nvar getPreferredCodecInfo = require('./rtc/sdp').getPreferredCodecInfo;\n\nvar BACKOFF_CONFIG = {\n  factor: 1.1,\n  initialDelay: 1,\n  maxDelay: 30000,\n  randomisationFactor: 0.5\n};\nvar DTMF_INTER_TONE_GAP = 70;\nvar DTMF_PAUSE_DURATION = 500;\nvar DTMF_TONE_DURATION = 160;\nvar METRICS_BATCH_SIZE = 10;\nvar METRICS_DELAY = 5000;\nvar MEDIA_DISCONNECT_ERROR = {\n  disconnect: true,\n  info: {\n    code: 31003,\n    message: 'Connection with Twilio was interrupted.',\n    twilioError: new errors_1.MediaErrors.ConnectionError()\n  }\n};\nvar MULTIPLE_THRESHOLD_WARNING_NAMES = {\n  // The stat `packetsLostFraction` is monitored by two separate thresholds,\n  // `maxAverage` and `max`. Each threshold emits a different warning name.\n  packetsLostFraction: {\n    max: 'packet-loss',\n    maxAverage: 'packets-lost-fraction'\n  }\n};\nvar WARNING_NAMES = {\n  audioInputLevel: 'audio-input-level',\n  audioOutputLevel: 'audio-output-level',\n  bytesReceived: 'bytes-received',\n  bytesSent: 'bytes-sent',\n  jitter: 'jitter',\n  mos: 'mos',\n  rtt: 'rtt'\n};\nvar WARNING_PREFIXES = {\n  max: 'high-',\n  maxAverage: 'high-',\n  maxDuration: 'constant-',\n  min: 'low-',\n  minStandardDeviation: 'constant-'\n};\nvar hasBeenWarnedHandlers = false;\n/**\n * A {@link Connection} represents a media and signaling connection to a TwiML application.\n * @publicapi\n */\n\nvar Connection =\n/** @class */\nfunction (_super) {\n  __extends(Connection, _super);\n  /**\n   * @constructor\n   * @private\n   * @param config - Mandatory configuration options\n   * @param [options] - Optional settings\n   */\n\n\n  function Connection(config, options) {\n    var _this = _super.call(this) || this;\n    /**\n     * Call parameters received from Twilio for an incoming call.\n     */\n\n\n    _this.parameters = {};\n    /**\n     * The number of times input volume has been the same consecutively.\n     */\n\n    _this._inputVolumeStreak = 0;\n    /**\n     * Whether the call has been answered.\n     */\n\n    _this._isAnswered = false;\n    /**\n     * Whether the call has been cancelled.\n     */\n\n    _this._isCancelled = false;\n    /**\n     * The most recent public input volume value. 0 -> 1 representing -100 to -30 dB.\n     */\n\n    _this._latestInputVolume = 0;\n    /**\n     * The most recent public output volume value. 0 -> 1 representing -100 to -30 dB.\n     */\n\n    _this._latestOutputVolume = 0;\n    /**\n     * An instance of Logger to use.\n     */\n\n    _this._log = log_1.default.getInstance();\n    /**\n     * A batch of metrics samples to send to Insights. Gets cleared after\n     * each send and appended to on each new sample.\n     */\n\n    _this._metricsSamples = [];\n    /**\n     * The number of times output volume has been the same consecutively.\n     */\n\n    _this._outputVolumeStreak = 0;\n    /**\n     * A Map of Sounds to play.\n     */\n\n    _this._soundcache = new Map();\n    /**\n     * State of the {@link Connection}.\n     */\n\n    _this._status = Connection.State.Pending;\n    /**\n     * Options passed to this {@link Connection}.\n     */\n\n    _this.options = {\n      enableRingingState: false,\n      mediaStreamFactory: PeerConnection,\n      offerSdp: null,\n      shouldPlayDisconnect: function () {\n        return true;\n      }\n    };\n    /**\n     * Whether the {@link Connection} should send a hangup on disconnect.\n     */\n\n    _this.sendHangup = true;\n    /**\n     * String representation of {@link Connection} instance.\n     * @private\n     */\n\n    _this.toString = function () {\n      return '[Twilio.Connection instance]';\n    };\n\n    _this._emitWarning = function (groupPrefix, warningName, threshold, value, wasCleared, warningData) {\n      var groupSuffix = wasCleared ? '-cleared' : '-raised';\n      var groupName = groupPrefix + \"warning\" + groupSuffix; // Ignore constant input if the Connection is muted (Expected)\n\n      if (warningName === 'constant-audio-input-level' && _this.isMuted()) {\n        return;\n      }\n\n      var level = wasCleared ? 'info' : 'warning'; // Avoid throwing false positives as warnings until we refactor volume metrics\n\n      if (warningName === 'constant-audio-output-level') {\n        level = 'info';\n      }\n\n      var payloadData = {\n        threshold: threshold\n      };\n\n      if (value) {\n        if (value instanceof Array) {\n          payloadData.values = value.map(function (val) {\n            if (typeof val === 'number') {\n              return Math.round(val * 100) / 100;\n            }\n\n            return value;\n          });\n        } else {\n          payloadData.value = value;\n        }\n      }\n\n      _this._publisher.post(level, groupName, warningName, {\n        data: payloadData\n      }, _this);\n\n      if (warningName !== 'constant-audio-output-level') {\n        var emitName = wasCleared ? 'warning-cleared' : 'warning';\n\n        _this.emit(emitName, warningName, warningData && !wasCleared ? warningData : null);\n      }\n    };\n    /**\n     * Called when the {@link Connection} is answered.\n     * @param payload\n     */\n\n\n    _this._onAnswer = function (payload) {\n      // answerOnBridge=false will send a 183 which we need to catch in _onRinging when\n      // the enableRingingState flag is disabled. In that case, we will receive a 200 after\n      // the callee accepts the call firing a second `accept` event if we don't\n      // short circuit here.\n      if (_this._isAnswered) {\n        return;\n      }\n\n      _this._setCallSid(payload);\n\n      _this._isAnswered = true;\n\n      _this._maybeTransitionToOpen();\n    };\n    /**\n     * Called when the {@link Connection} is cancelled.\n     * @param payload\n     */\n\n\n    _this._onCancel = function (payload) {\n      // (rrowland) Is this check necessary? Verify, and if so move to pstream / VSP module.\n      var callsid = payload.callsid;\n\n      if (_this.parameters.CallSid === callsid) {\n        _this._isCancelled = true;\n\n        _this._publisher.info('connection', 'cancel', null, _this);\n\n        _this._cleanupEventListeners();\n\n        _this.mediaStream.close();\n\n        _this._status = Connection.State.Closed;\n\n        _this.emit('cancel');\n\n        _this.pstream.removeListener('cancel', _this._onCancel);\n      }\n    };\n    /**\n     * Called when the {@link Connection} is hung up.\n     * @param payload\n     */\n\n\n    _this._onHangup = function (payload) {\n      /**\n       *  see if callsid passed in message matches either callsid or outbound id\n       *  connection should always have either callsid or outbound id\n       *  if no callsid passed hangup anyways\n       */\n      if (payload.callsid && (_this.parameters.CallSid || _this.outboundConnectionId)) {\n        if (payload.callsid !== _this.parameters.CallSid && payload.callsid !== _this.outboundConnectionId) {\n          return;\n        }\n      } else if (payload.callsid) {\n        // hangup is for another connection\n        return;\n      }\n\n      _this._log.info('Received HANGUP from gateway');\n\n      if (payload.error) {\n        var error = {\n          code: payload.error.code || 31000,\n          connection: _this,\n          message: payload.error.message || 'Error sent from gateway in HANGUP',\n          twilioError: new errors_1.GeneralErrors.ConnectionError()\n        };\n\n        _this._log.error('Received an error from the gateway:', error);\n\n        _this.emit('error', error);\n      }\n\n      _this.sendHangup = false;\n\n      _this._publisher.info('connection', 'disconnected-by-remote', null, _this);\n\n      _this._disconnect(null, true);\n\n      _this._cleanupEventListeners();\n    };\n    /**\n     * Called when there is a media failure.\n     * Manages all media-related states and takes action base on the states\n     * @param type - Type of media failure\n     */\n\n\n    _this._onMediaFailure = function (type) {\n      var _a = Connection.MediaFailure,\n          ConnectionDisconnected = _a.ConnectionDisconnected,\n          ConnectionFailed = _a.ConnectionFailed,\n          IceGatheringFailed = _a.IceGatheringFailed,\n          LowBytes = _a.LowBytes; // These types signifies the end of a single ICE cycle\n\n      var isEndOfIceCycle = type === ConnectionFailed || type === IceGatheringFailed; // Default behavior on ice failures with disabled ice restart.\n\n      if (!_this.options.enableIceRestart && isEndOfIceCycle || // All browsers except chrome doesn't update pc.iceConnectionState and pc.connectionState\n      // after issuing an ICE Restart, which we use to determine if ICE Restart is complete.\n      // Since we cannot detect if ICE Restart is complete, we will not retry.\n      !util_1.isChrome(window, window.navigator) && type === ConnectionFailed) {\n        return _this.mediaStream.onerror(MEDIA_DISCONNECT_ERROR);\n      } // Ignore any other type of media failure if ice restart is disabled\n\n\n      if (!_this.options.enableIceRestart) {\n        return;\n      } // Ignore subsequent requests if ice restart is in progress\n\n\n      if (_this._status === Connection.State.Reconnecting) {\n        // This is a retry. Previous ICE Restart failed\n        if (isEndOfIceCycle) {\n          // We already exceeded max retry time.\n          if (Date.now() - _this._mediaReconnectStartTime > BACKOFF_CONFIG.maxDelay) {\n            _this._log.info('Exceeded max ICE retries');\n\n            return _this.mediaStream.onerror(MEDIA_DISCONNECT_ERROR);\n          } // Issue ICE restart with backoff\n\n\n          _this._mediaReconnectBackoff.backoff();\n        }\n\n        return;\n      }\n\n      var pc = _this.mediaStream.version.pc;\n      var isIceDisconnected = pc && pc.iceConnectionState === 'disconnected';\n\n      var hasLowBytesWarning = _this._monitor.hasActiveWarning('bytesSent', 'min') || _this._monitor.hasActiveWarning('bytesReceived', 'min'); // Only certain conditions can trigger media reconnection\n\n\n      if (type === LowBytes && isIceDisconnected || type === ConnectionDisconnected && hasLowBytesWarning || isEndOfIceCycle) {\n        var mediaReconnectionError = {\n          code: 53405,\n          message: 'Media connection failed.',\n          twilioError: new errors_1.MediaErrors.ConnectionError()\n        };\n\n        _this._log.warn('ICE Connection disconnected.');\n\n        _this._publisher.warn('connection', 'error', mediaReconnectionError, _this);\n\n        _this._publisher.info('connection', 'reconnecting', null, _this);\n\n        _this._mediaReconnectStartTime = Date.now();\n        _this._status = Connection.State.Reconnecting;\n\n        _this._mediaReconnectBackoff.reset();\n\n        _this._mediaReconnectBackoff.backoff();\n\n        _this.emit('reconnecting', mediaReconnectionError);\n      }\n    };\n    /**\n     * Called when media connection is restored\n     */\n\n\n    _this._onMediaReconnected = function () {\n      // Only trigger once.\n      // This can trigger on pc.onIceConnectionChange and pc.onConnectionChange.\n      if (_this._status !== Connection.State.Reconnecting) {\n        return;\n      }\n\n      _this._log.info('ICE Connection reestablished.');\n\n      _this._publisher.info('connection', 'reconnected', null, _this);\n\n      _this._status = Connection.State.Open;\n\n      _this.emit('reconnected');\n    };\n    /**\n     * When we get a RINGING signal from PStream, update the {@link Connection} status.\n     * @param payload\n     */\n\n\n    _this._onRinging = function (payload) {\n      _this._setCallSid(payload); // If we're not in 'connecting' or 'ringing' state, this event was received out of order.\n\n\n      if (_this._status !== Connection.State.Connecting && _this._status !== Connection.State.Ringing) {\n        return;\n      }\n\n      var hasEarlyMedia = !!payload.sdp;\n\n      if (_this.options.enableRingingState) {\n        _this._status = Connection.State.Ringing;\n\n        _this._publisher.info('connection', 'outgoing-ringing', {\n          hasEarlyMedia: hasEarlyMedia\n        }, _this);\n\n        _this.emit('ringing', hasEarlyMedia); // answerOnBridge=false will send a 183, which we need to interpret as `answer` when\n        // the enableRingingState flag is disabled in order to maintain a non-breaking API from 1.4.24\n\n      } else if (hasEarlyMedia) {\n        _this._onAnswer(payload);\n      }\n    };\n    /**\n     * Called each time StatsMonitor emits a sample.\n     * Emits stats event and batches the call stats metrics and sends them to Insights.\n     * @param sample\n     */\n\n\n    _this._onRTCSample = function (sample) {\n      var callMetrics = __assign(__assign({}, sample), {\n        inputVolume: _this._latestInputVolume,\n        outputVolume: _this._latestOutputVolume\n      });\n\n      _this._codec = callMetrics.codecName;\n\n      _this._metricsSamples.push(callMetrics);\n\n      if (_this._metricsSamples.length >= METRICS_BATCH_SIZE) {\n        _this._publishMetrics();\n      }\n\n      _this.emit('sample', sample);\n    };\n    /**\n     * Called when we receive a transportClose event from pstream.\n     * Re-emits the event.\n     */\n\n\n    _this._onTransportClose = function () {\n      _this._log.error('Received transportClose from pstream');\n\n      _this.emit('transportClose');\n    };\n    /**\n     * Re-emit an StatsMonitor warning as a {@link Connection}.warning or .warning-cleared event.\n     * @param warningData\n     * @param wasCleared - Whether this is a -cleared or -raised event.\n     */\n\n\n    _this._reemitWarning = function (warningData, wasCleared) {\n      var groupPrefix = /^audio/.test(warningData.name) ? 'audio-level-' : 'network-quality-';\n      var warningPrefix = WARNING_PREFIXES[warningData.threshold.name];\n      /**\n       * NOTE: There are two \"packet-loss\" warnings: `high-packet-loss` and\n       * `high-packets-lost-fraction`, so in this case we need to use a different\n       * `WARNING_NAME` mapping.\n       */\n\n      var warningName;\n\n      if (warningData.name in MULTIPLE_THRESHOLD_WARNING_NAMES) {\n        warningName = MULTIPLE_THRESHOLD_WARNING_NAMES[warningData.name][warningData.threshold.name];\n      } else if (warningData.name in WARNING_NAMES) {\n        warningName = WARNING_NAMES[warningData.name];\n      }\n\n      var warning = warningPrefix + warningName;\n\n      _this._emitWarning(groupPrefix, warning, warningData.threshold.value, warningData.values || warningData.value, wasCleared, warningData);\n    };\n    /**\n     * Re-emit an StatsMonitor warning-cleared as a .warning-cleared event.\n     * @param warningData\n     */\n\n\n    _this._reemitWarningCleared = function (warningData) {\n      _this._reemitWarning(warningData, true);\n    };\n\n    _this._isUnifiedPlanDefault = config.isUnifiedPlanDefault;\n    _this._soundcache = config.soundcache;\n    _this.message = options && options.twimlParams || {};\n    _this.customParameters = new Map(Object.entries(_this.message).map(function (_a) {\n      var key = _a[0],\n          val = _a[1];\n      return [key, String(val)];\n    }));\n    Object.assign(_this.options, options);\n\n    if (_this.options.callParameters) {\n      _this.parameters = _this.options.callParameters;\n    }\n\n    _this._direction = _this.parameters.CallSid ? Connection.CallDirection.Incoming : Connection.CallDirection.Outgoing;\n\n    if (_this._direction === Connection.CallDirection.Incoming && _this.parameters) {\n      _this.callerInfo = _this.parameters.StirStatus ? {\n        isVerified: _this.parameters.StirStatus === 'TN-Validation-Passed-A'\n      } : null;\n    } else {\n      _this.callerInfo = null;\n    }\n\n    _this._mediaReconnectBackoff = Backoff.exponential(BACKOFF_CONFIG);\n\n    _this._mediaReconnectBackoff.on('ready', function () {\n      return _this.mediaStream.iceRestart();\n    }); // temporary call sid to be used for outgoing calls\n\n\n    _this.outboundConnectionId = generateTempCallSid();\n    var publisher = _this._publisher = config.publisher;\n\n    if (_this._direction === Connection.CallDirection.Incoming) {\n      publisher.info('connection', 'incoming', null, _this);\n    } else {\n      publisher.info('connection', 'outgoing', {\n        preflight: _this.options.preflight\n      }, _this);\n    }\n\n    var monitor = _this._monitor = new (_this.options.StatsMonitor || statsMonitor_1.default)();\n    monitor.on('sample', _this._onRTCSample); // First 20 seconds or so are choppy, so let's not bother with these warnings.\n\n    monitor.disableWarnings();\n    setTimeout(function () {\n      return monitor.enableWarnings();\n    }, METRICS_DELAY);\n    monitor.on('warning', function (data, wasCleared) {\n      if (data.name === 'bytesSent' || data.name === 'bytesReceived') {\n        _this._onMediaFailure(Connection.MediaFailure.LowBytes);\n      }\n\n      _this._reemitWarning(data, wasCleared);\n    });\n    monitor.on('warning-cleared', function (data) {\n      _this._reemitWarningCleared(data);\n    });\n    _this.mediaStream = new (_this.options.MediaStream || _this.options.mediaStreamFactory)(config.audioHelper, config.pstream, config.getUserMedia, {\n      codecPreferences: _this.options.codecPreferences,\n      dscp: _this.options.dscp,\n      enableIceRestart: _this.options.enableIceRestart,\n      forceAggressiveIceNomination: _this.options.forceAggressiveIceNomination,\n      isUnifiedPlan: _this._isUnifiedPlanDefault,\n      maxAverageBitrate: _this.options.maxAverageBitrate,\n      preflight: _this.options.preflight\n    });\n\n    _this.on('volume', function (inputVolume, outputVolume) {\n      _this._inputVolumeStreak = _this._checkVolume(inputVolume, _this._inputVolumeStreak, _this._latestInputVolume, 'input');\n      _this._outputVolumeStreak = _this._checkVolume(outputVolume, _this._outputVolumeStreak, _this._latestOutputVolume, 'output');\n      _this._latestInputVolume = inputVolume;\n      _this._latestOutputVolume = outputVolume;\n    });\n\n    _this.mediaStream.onvolume = function (inputVolume, outputVolume, internalInputVolume, internalOutputVolume) {\n      // (rrowland) These values mock the 0 -> 32767 format used by legacy getStats. We should look into\n      // migrating to a newer standard, either 0.0 -> linear or -127 to 0 in dB, matching the range\n      // chosen below.\n      monitor.addVolumes(internalInputVolume / 255 * 32767, internalOutputVolume / 255 * 32767); // (rrowland) 0.0 -> 1.0 linear\n\n      _this.emit('volume', inputVolume, outputVolume);\n    };\n\n    _this.mediaStream.ondtlstransportstatechange = function (state) {\n      var level = state === 'failed' ? 'error' : 'debug';\n\n      _this._publisher.post(level, 'dtls-transport-state', state, null, _this);\n    };\n\n    _this.mediaStream.onpcconnectionstatechange = function (state) {\n      var level = 'debug';\n\n      var dtlsTransport = _this.mediaStream.getRTCDtlsTransport();\n\n      if (state === 'failed') {\n        level = dtlsTransport && dtlsTransport.state === 'failed' ? 'error' : 'warning';\n      }\n\n      _this._publisher.post(level, 'pc-connection-state', state, null, _this);\n    };\n\n    _this.mediaStream.onicecandidate = function (candidate) {\n      var payload = new icecandidate_1.IceCandidate(candidate).toPayload();\n\n      _this._publisher.debug('ice-candidate', 'ice-candidate', payload, _this);\n    };\n\n    _this.mediaStream.onselectedcandidatepairchange = function (pair) {\n      var localCandidatePayload = new icecandidate_1.IceCandidate(pair.local).toPayload();\n      var remoteCandidatePayload = new icecandidate_1.IceCandidate(pair.remote, true).toPayload();\n\n      _this._publisher.debug('ice-candidate', 'selected-ice-candidate-pair', {\n        local_candidate: localCandidatePayload,\n        remote_candidate: remoteCandidatePayload\n      }, _this);\n    };\n\n    _this.mediaStream.oniceconnectionstatechange = function (state) {\n      var level = state === 'failed' ? 'error' : 'debug';\n\n      _this._publisher.post(level, 'ice-connection-state', state, null, _this);\n    };\n\n    _this.mediaStream.onicegatheringfailure = function (type) {\n      _this._publisher.warn('ice-gathering-state', type, null, _this);\n\n      _this._onMediaFailure(Connection.MediaFailure.IceGatheringFailed);\n    };\n\n    _this.mediaStream.onicegatheringstatechange = function (state) {\n      _this._publisher.debug('ice-gathering-state', state, null, _this);\n    };\n\n    _this.mediaStream.onsignalingstatechange = function (state) {\n      _this._publisher.debug('signaling-state', state, null, _this);\n    };\n\n    _this.mediaStream.ondisconnected = function (msg) {\n      _this._log.info(msg);\n\n      _this._publisher.warn('network-quality-warning-raised', 'ice-connectivity-lost', {\n        message: msg\n      }, _this);\n\n      _this.emit('warning', 'ice-connectivity-lost');\n\n      _this._onMediaFailure(Connection.MediaFailure.ConnectionDisconnected);\n    };\n\n    _this.mediaStream.onfailed = function (msg) {\n      _this._onMediaFailure(Connection.MediaFailure.ConnectionFailed);\n    };\n\n    _this.mediaStream.onconnected = function () {\n      // First time mediaStream is connected, but ICE Gathering issued an ICE restart and succeeded.\n      if (_this._status === Connection.State.Reconnecting) {\n        _this._onMediaReconnected();\n      }\n    };\n\n    _this.mediaStream.onreconnected = function (msg) {\n      _this._log.info(msg);\n\n      _this._publisher.info('network-quality-warning-cleared', 'ice-connectivity-lost', {\n        message: msg\n      }, _this);\n\n      _this.emit('warning-cleared', 'ice-connectivity-lost');\n\n      _this._onMediaReconnected();\n    };\n\n    _this.mediaStream.onerror = function (e) {\n      if (e.disconnect === true) {\n        _this._disconnect(e.info && e.info.message);\n      }\n\n      var error = {\n        code: e.info.code,\n        connection: _this,\n        info: e.info,\n        message: e.info.message || 'Error with mediastream',\n        twilioError: e.info.twilioError\n      };\n\n      _this._log.error('Received an error from MediaStream:', e);\n\n      _this.emit('error', error);\n    };\n\n    _this.mediaStream.onopen = function () {\n      // NOTE(mroberts): While this may have been happening in previous\n      // versions of Chrome, since Chrome 45 we have seen the\n      // PeerConnection's onsignalingstatechange handler invoked multiple\n      // times in the same signalingState 'stable'. When this happens, we\n      // invoke this onopen function. If we invoke it twice without checking\n      // for _status 'open', we'd accidentally close the PeerConnection.\n      //\n      // See <https://code.google.com/p/webrtc/issues/detail?id=4996>.\n      if (_this._status === Connection.State.Open || _this._status === Connection.State.Reconnecting) {\n        return;\n      } else if (_this._status === Connection.State.Ringing || _this._status === Connection.State.Connecting) {\n        _this.mute(false);\n\n        _this._maybeTransitionToOpen();\n      } else {\n        // call was probably canceled sometime before this\n        _this.mediaStream.close();\n      }\n    };\n\n    _this.mediaStream.onclose = function () {\n      _this._status = Connection.State.Closed;\n\n      if (_this.options.shouldPlayDisconnect && _this.options.shouldPlayDisconnect() // Don't play disconnect sound if this was from a cancel event. i.e. the call\n      // was ignored or hung up even before it was answered.\n      && !_this._isCancelled) {\n        _this._soundcache.get(device_1.default.SoundName.Disconnect).play();\n      }\n\n      monitor.disable();\n\n      _this._publishMetrics();\n\n      if (!_this._isCancelled) {\n        _this.emit('disconnect', _this);\n      }\n    };\n\n    _this.pstream = config.pstream;\n\n    _this.pstream.on('cancel', _this._onCancel);\n\n    _this.pstream.on('ringing', _this._onRinging);\n\n    _this.pstream.on('transportClose', _this._onTransportClose);\n\n    _this.on('error', function (error) {\n      _this._publisher.error('connection', 'error', {\n        code: error.code,\n        message: error.message\n      }, _this);\n\n      if (_this.pstream && _this.pstream.status === 'disconnected') {\n        _this._cleanupEventListeners();\n      }\n    });\n\n    _this.on('disconnect', function () {\n      _this._cleanupEventListeners();\n    });\n\n    return _this;\n  }\n\n  Object.defineProperty(Connection.prototype, \"direction\", {\n    /**\n     * Whether this {@link Connection} is incoming or outgoing.\n     */\n    get: function () {\n      return this._direction;\n    },\n    enumerable: true,\n    configurable: true\n  });\n  Object.defineProperty(Connection.prototype, \"codec\", {\n    /**\n     * Audio codec used for this {@link Connection}. Expecting {@link Connection.Codec} but\n     * will copy whatever we get from RTC stats.\n     */\n    get: function () {\n      return this._codec;\n    },\n    enumerable: true,\n    configurable: true\n  });\n  /**\n   * Get the real CallSid. Returns null if not present or is a temporary call sid.\n   * @deprecated\n   * @private\n   */\n\n  Connection.prototype._getRealCallSid = function () {\n    this._log.warn('_getRealCallSid is deprecated and will be removed in 2.0.');\n\n    return /^TJ/.test(this.parameters.CallSid) ? null : this.parameters.CallSid;\n  };\n  /**\n   * Get the temporary CallSid.\n   * @deprecated\n   * @private\n   */\n\n\n  Connection.prototype._getTempCallSid = function () {\n    this._log.warn('_getTempCallSid is deprecated and will be removed in 2.0. \\\n                    Please use outboundConnectionId instead.');\n\n    return this.outboundConnectionId;\n  };\n  /**\n   * Set the audio input tracks from a given stream.\n   * @param stream\n   * @private\n   */\n\n\n  Connection.prototype._setInputTracksFromStream = function (stream) {\n    return this.mediaStream.setInputTracksFromStream(stream);\n  };\n  /**\n   * Set the audio output sink IDs.\n   * @param sinkIds\n   * @private\n   */\n\n\n  Connection.prototype._setSinkIds = function (sinkIds) {\n    return this.mediaStream._setSinkIds(sinkIds);\n  };\n\n  Connection.prototype.accept = function (handlerOrConstraints, rtcConfiguration) {\n    var _this = this;\n\n    if (typeof handlerOrConstraints === 'function') {\n      this._addHandler('accept', handlerOrConstraints);\n\n      return;\n    }\n\n    if (this._status !== Connection.State.Pending) {\n      return;\n    }\n\n    var audioConstraints = handlerOrConstraints || this.options.audioConstraints;\n    this._status = Connection.State.Connecting;\n\n    var connect = function () {\n      if (_this._status !== Connection.State.Connecting) {\n        // call must have been canceled\n        _this._cleanupEventListeners();\n\n        _this.mediaStream.close();\n\n        return;\n      }\n\n      var onAnswer = function (pc) {\n        // Report that the call was answered, and directionality\n        var eventName = _this._direction === Connection.CallDirection.Incoming ? 'accepted-by-local' : 'accepted-by-remote';\n\n        _this._publisher.info('connection', eventName, null, _this); // Report the preferred codec and params as they appear in the SDP\n\n\n        var _a = getPreferredCodecInfo(_this.mediaStream.version.getSDP()),\n            codecName = _a.codecName,\n            codecParams = _a.codecParams;\n\n        _this._publisher.info('settings', 'codec', {\n          codec_params: codecParams,\n          selected_codec: codecName\n        }, _this); // Enable RTC monitoring\n\n\n        _this._monitor.enable(pc);\n      };\n\n      var sinkIds = typeof _this.options.getSinkIds === 'function' && _this.options.getSinkIds();\n\n      if (Array.isArray(sinkIds)) {\n        _this.mediaStream._setSinkIds(sinkIds).catch(function () {// (rrowland) We don't want this to throw to console since the customer\n          // can't control this. This will most commonly be rejected on browsers\n          // that don't support setting sink IDs.\n        });\n      }\n\n      _this.pstream.addListener('hangup', _this._onHangup);\n\n      rtcConfiguration = rtcConfiguration || _this.options.rtcConfiguration;\n\n      if (_this._direction === Connection.CallDirection.Incoming) {\n        _this._isAnswered = true;\n\n        _this.mediaStream.answerIncomingCall(_this.parameters.CallSid, _this.options.offerSdp, _this.options.rtcConstraints, rtcConfiguration, onAnswer);\n      } else {\n        var params = Array.from(_this.customParameters.entries()).map(function (pair) {\n          return encodeURIComponent(pair[0]) + \"=\" + encodeURIComponent(pair[1]);\n        }).join('&');\n\n        _this.pstream.once('answer', _this._onAnswer.bind(_this));\n\n        _this.mediaStream.makeOutgoingCall(_this.pstream.token, params, _this.outboundConnectionId, _this.options.rtcConstraints, rtcConfiguration, onAnswer);\n      }\n    };\n\n    if (this.options.beforeAccept) {\n      this.options.beforeAccept(this);\n    }\n\n    var inputStream = typeof this.options.getInputStream === 'function' && this.options.getInputStream();\n    var promise = inputStream ? this.mediaStream.setInputTracksFromStream(inputStream) : this.mediaStream.openWithConstraints(audioConstraints);\n    promise.then(function () {\n      _this._publisher.info('get-user-media', 'succeeded', {\n        data: {\n          audioConstraints: audioConstraints\n        }\n      }, _this);\n\n      connect();\n    }, function (error) {\n      var message;\n      var code;\n\n      if (error.code === 31208 || ['PermissionDeniedError', 'NotAllowedError'].indexOf(error.name) !== -1) {\n        code = 31208;\n        message = 'User denied access to microphone, or the web browser did not allow microphone ' + 'access at this address.';\n\n        _this._publisher.error('get-user-media', 'denied', {\n          data: {\n            audioConstraints: audioConstraints,\n            error: error\n          }\n        }, _this);\n      } else {\n        code = 31201;\n        message = \"Error occurred while accessing microphone: \" + error.name + (error.message ? \" (\" + error.message + \")\" : '');\n\n        _this._publisher.error('get-user-media', 'failed', {\n          data: {\n            audioConstraints: audioConstraints,\n            error: error\n          }\n        }, _this);\n      }\n\n      _this._disconnect();\n\n      _this.emit('error', {\n        message: message,\n        code: code\n      });\n    });\n  };\n\n  Connection.prototype.cancel = function (handler) {\n    this._log.warn('.cancel() is deprecated. Please use .ignore() instead.');\n\n    if (handler) {\n      this.ignore(handler);\n    } else {\n      this.ignore();\n    }\n  };\n\n  Connection.prototype.disconnect = function (handler) {\n    if (typeof handler === 'function') {\n      this._addHandler('disconnect', handler);\n\n      return;\n    }\n\n    this._disconnect();\n  };\n  /**\n   * @deprecated - Set a handler for the {@link errorEvent}\n   */\n\n\n  Connection.prototype.error = function (handler) {\n    if (typeof handler === 'function') {\n      this._addHandler('error', handler);\n    }\n  };\n  /**\n   * Get the local MediaStream, if set.\n   */\n\n\n  Connection.prototype.getLocalStream = function () {\n    return this.mediaStream && this.mediaStream.stream;\n  };\n  /**\n   * Get the remote MediaStream, if set.\n   */\n\n\n  Connection.prototype.getRemoteStream = function () {\n    return this.mediaStream && this.mediaStream._remoteStream;\n  };\n\n  Connection.prototype.ignore = function (handler) {\n    if (typeof handler === 'function') {\n      this._addHandler('cancel', handler);\n\n      return;\n    }\n\n    if (this._status !== Connection.State.Pending) {\n      return;\n    }\n\n    this._status = Connection.State.Closed;\n    this.emit('cancel');\n    this.mediaStream.ignore(this.parameters.CallSid);\n\n    this._publisher.info('connection', 'ignored-by-local', null, this);\n  };\n  /**\n   * Check if connection is muted\n   */\n\n\n  Connection.prototype.isMuted = function () {\n    return this.mediaStream.isMuted;\n  };\n\n  Connection.prototype.mute = function (shouldMute) {\n    if (shouldMute === void 0) {\n      shouldMute = true;\n    }\n\n    if (typeof shouldMute === 'function') {\n      this._addHandler('mute', shouldMute);\n\n      return;\n    }\n\n    var wasMuted = this.mediaStream.isMuted;\n    this.mediaStream.mute(shouldMute);\n    var isMuted = this.mediaStream.isMuted;\n\n    if (wasMuted !== isMuted) {\n      this._publisher.info('connection', isMuted ? 'muted' : 'unmuted', null, this);\n\n      this.emit('mute', isMuted, this);\n    }\n  };\n  /**\n   * Post an event to Endpoint Analytics indicating that the end user\n   *   has given call quality feedback. Called without a score, this\n   *   will report that the customer declined to give feedback.\n   * @param score - The end-user's rating of the call; an\n   *   integer 1 through 5. Or undefined if the user declined to give\n   *   feedback.\n   * @param issue - The primary issue the end user\n   *   experienced on the call. Can be: ['one-way-audio', 'choppy-audio',\n   *   'dropped-call', 'audio-latency', 'noisy-call', 'echo']\n   */\n\n\n  Connection.prototype.postFeedback = function (score, issue) {\n    if (typeof score === 'undefined' || score === null) {\n      return this._postFeedbackDeclined();\n    }\n\n    if (!Object.values(Connection.FeedbackScore).includes(score)) {\n      throw new errors_1.InvalidArgumentError(\"Feedback score must be one of: \" + Object.values(Connection.FeedbackScore));\n    }\n\n    if (typeof issue !== 'undefined' && issue !== null && !Object.values(Connection.FeedbackIssue).includes(issue)) {\n      throw new errors_1.InvalidArgumentError(\"Feedback issue must be one of: \" + Object.values(Connection.FeedbackIssue));\n    }\n\n    return this._publisher.info('feedback', 'received', {\n      issue_name: issue,\n      quality_score: score\n    }, this, true);\n  };\n\n  Connection.prototype.reject = function (handler) {\n    if (typeof handler === 'function') {\n      this._addHandler('reject', handler);\n\n      return;\n    }\n\n    if (this._status !== Connection.State.Pending) {\n      return;\n    }\n\n    this.pstream.reject(this.parameters.CallSid);\n    this._status = Connection.State.Closed;\n    this.emit('reject');\n    this.mediaStream.reject(this.parameters.CallSid);\n\n    this._publisher.info('connection', 'rejected-by-local', null, this);\n  };\n  /**\n   * Send a string of digits.\n   * @param digits\n   */\n\n\n  Connection.prototype.sendDigits = function (digits) {\n    if (digits.match(/[^0-9*#w]/)) {\n      throw new errors_1.InvalidArgumentError('Illegal character passed into sendDigits');\n    }\n\n    var sequence = [];\n    digits.split('').forEach(function (digit) {\n      var dtmf = digit !== 'w' ? \"dtmf\" + digit : '';\n\n      if (dtmf === 'dtmf*') {\n        dtmf = 'dtmfs';\n      }\n\n      if (dtmf === 'dtmf#') {\n        dtmf = 'dtmfh';\n      }\n\n      sequence.push(dtmf);\n    }); // Binds soundCache to be used in recursion until all digits have been played.\n\n    (function playNextDigit(soundCache, dialtonePlayer) {\n      var digit = sequence.shift();\n\n      if (digit) {\n        if (dialtonePlayer) {\n          dialtonePlayer.play(digit);\n        } else {\n          soundCache.get(digit).play();\n        }\n      }\n\n      if (sequence.length) {\n        setTimeout(playNextDigit.bind(null, soundCache), 200);\n      }\n    })(this._soundcache, this.options.dialtonePlayer);\n\n    var dtmfSender = this.mediaStream.getOrCreateDTMFSender();\n\n    function insertDTMF(dtmfs) {\n      if (!dtmfs.length) {\n        return;\n      }\n\n      var dtmf = dtmfs.shift();\n\n      if (dtmf && dtmf.length) {\n        dtmfSender.insertDTMF(dtmf, DTMF_TONE_DURATION, DTMF_INTER_TONE_GAP);\n      }\n\n      setTimeout(insertDTMF.bind(null, dtmfs), DTMF_PAUSE_DURATION);\n    }\n\n    if (dtmfSender) {\n      if (!('canInsertDTMF' in dtmfSender) || dtmfSender.canInsertDTMF) {\n        this._log.info('Sending digits using RTCDTMFSender'); // NOTE(mroberts): We can't just map 'w' to ',' since\n        // RTCDTMFSender's pause duration is 2 s and Twilio's is more\n        // like 500 ms. Instead, we will fudge it with setTimeout.\n\n\n        insertDTMF(digits.split('w'));\n        return;\n      }\n\n      this._log.info('RTCDTMFSender cannot insert DTMF');\n    } // send pstream message to send DTMF\n\n\n    this._log.info('Sending digits over PStream');\n\n    if (this.pstream !== null && this.pstream.status !== 'disconnected') {\n      this.pstream.dtmf(this.parameters.CallSid, digits);\n    } else {\n      var error = {\n        code: 31000,\n        connection: this,\n        message: 'Could not send DTMF: Signaling channel is disconnected'\n      };\n      this.emit('error', error);\n    }\n  };\n  /**\n   * Get the current {@link Connection} status.\n   */\n\n\n  Connection.prototype.status = function () {\n    return this._status;\n  };\n  /**\n   * @deprecated - Unmute the {@link Connection}.\n   */\n\n\n  Connection.prototype.unmute = function () {\n    this._log.warn('.unmute() is deprecated. Please use .mute(false) to unmute a call instead.');\n\n    this.mute(false);\n  };\n  /**\n   * @deprecated - Set a handler for the {@link volumeEvent}\n   * @param handler\n   */\n\n\n  Connection.prototype.volume = function (handler) {\n    if (!window || !window.AudioContext && !window.webkitAudioContext) {\n      this._log.warn('This browser does not support Connection.volume');\n    }\n\n    this._addHandler('volume', handler);\n  };\n  /**\n   * Add a handler for an EventEmitter and emit a deprecation warning on first call.\n   * @param eventName - Name of the event\n   * @param handler - A handler to call when the event is emitted\n   */\n\n\n  Connection.prototype._addHandler = function (eventName, handler) {\n    if (!hasBeenWarnedHandlers) {\n      this._log.warn(\"Connection callback handlers (accept, cancel, disconnect, error, ignore, mute, reject,\\n        volume) have been deprecated and will be removed in the next breaking release. Instead, the EventEmitter         interface can be used to set event listeners. Example: connection.on('\" + eventName + \"', handler)\");\n\n      hasBeenWarnedHandlers = true;\n    }\n\n    this.addListener(eventName, handler);\n    return this;\n  };\n  /**\n   * Check the volume passed, emitting a warning if one way audio is detected or cleared.\n   * @param currentVolume - The current volume for this direction\n   * @param streakFieldName - The name of the field on the {@link Connection} object that tracks how many times the\n   *   current value has been repeated consecutively.\n   * @param lastValueFieldName - The name of the field on the {@link Connection} object that tracks the most recent\n   *   volume for this direction\n   * @param direction - The directionality of this audio track, either 'input' or 'output'\n   * @returns The current streak; how many times in a row the same value has been polled.\n   */\n\n\n  Connection.prototype._checkVolume = function (currentVolume, currentStreak, lastValue, direction) {\n    var wasWarningRaised = currentStreak >= 10;\n    var newStreak = 0;\n\n    if (lastValue === currentVolume) {\n      newStreak = currentStreak;\n    }\n\n    if (newStreak >= 10) {\n      this._emitWarning('audio-level-', \"constant-audio-\" + direction + \"-level\", 10, newStreak, false);\n    } else if (wasWarningRaised) {\n      this._emitWarning('audio-level-', \"constant-audio-\" + direction + \"-level\", 10, newStreak, true);\n    }\n\n    return newStreak;\n  };\n  /**\n   * Clean up event listeners.\n   */\n\n\n  Connection.prototype._cleanupEventListeners = function () {\n    var _this = this;\n\n    var cleanup = function () {\n      if (!_this.pstream) {\n        return;\n      }\n\n      _this.pstream.removeListener('answer', _this._onAnswer);\n\n      _this.pstream.removeListener('cancel', _this._onCancel);\n\n      _this.pstream.removeListener('hangup', _this._onHangup);\n\n      _this.pstream.removeListener('ringing', _this._onRinging);\n\n      _this.pstream.removeListener('transportClose', _this._onTransportClose);\n    }; // This is kind of a hack, but it lets us avoid rewriting more code.\n    // Basically, there's a sequencing problem with the way PeerConnection raises\n    // the\n    //\n    //   Cannot establish connection. Client is disconnected\n    //\n    // error in Connection#accept. It calls PeerConnection#onerror, which emits\n    // the error event on Connection. An error handler on Connection then calls\n    // cleanupEventListeners, but then control returns to Connection#accept. It's\n    // at this point that we add a listener for the answer event that never gets\n    // removed. setTimeout will allow us to rerun cleanup again, _after_\n    // Connection#accept returns.\n\n\n    cleanup();\n    setTimeout(cleanup, 0);\n  };\n  /**\n   * Create the payload wrapper for a batch of metrics to be sent to Insights.\n   */\n\n\n  Connection.prototype._createMetricPayload = function () {\n    var payload = {\n      call_sid: this.parameters.CallSid,\n      dscp: !!this.options.dscp,\n      sdk_version: C.RELEASE_VERSION,\n      selected_region: this.options.selectedRegion\n    };\n\n    if (this.options.gateway) {\n      payload.gateway = this.options.gateway;\n    }\n\n    if (this.options.region) {\n      payload.region = this.options.region;\n    }\n\n    payload.direction = this._direction;\n    return payload;\n  };\n  /**\n   * Disconnect the {@link Connection}.\n   * @param message - A message explaining why the {@link Connection} is being disconnected.\n   * @param wasRemote - Whether the disconnect was triggered locally or remotely.\n   */\n\n\n  Connection.prototype._disconnect = function (message, wasRemote) {\n    message = typeof message === 'string' ? message : null;\n\n    if (this._status !== Connection.State.Open && this._status !== Connection.State.Connecting && this._status !== Connection.State.Reconnecting && this._status !== Connection.State.Ringing) {\n      return;\n    }\n\n    this._log.info('Disconnecting...'); // send pstream hangup message\n\n\n    if (this.pstream !== null && this.pstream.status !== 'disconnected' && this.sendHangup) {\n      var callsid = this.parameters.CallSid || this.outboundConnectionId;\n\n      if (callsid) {\n        this.pstream.hangup(callsid, message);\n      }\n    }\n\n    this._cleanupEventListeners();\n\n    this.mediaStream.close();\n\n    if (!wasRemote) {\n      this._publisher.info('connection', 'disconnected-by-local', null, this);\n    }\n  };\n  /**\n   * Transition to {@link ConnectionStatus.Open} if criteria is met.\n   */\n\n\n  Connection.prototype._maybeTransitionToOpen = function () {\n    if (this.mediaStream && this.mediaStream.status === 'open' && this._isAnswered) {\n      this._status = Connection.State.Open;\n      this.emit('accept', this);\n    }\n  };\n  /**\n   * Post an event to Endpoint Analytics indicating that the end user\n   *   has ignored a request for feedback.\n   */\n\n\n  Connection.prototype._postFeedbackDeclined = function () {\n    return this._publisher.info('feedback', 'received-none', null, this, true);\n  };\n  /**\n   * Publish the current set of queued metrics samples to Insights.\n   */\n\n\n  Connection.prototype._publishMetrics = function () {\n    var _this = this;\n\n    if (this._metricsSamples.length === 0) {\n      return;\n    }\n\n    this._publisher.postMetrics('quality-metrics-samples', 'metrics-sample', this._metricsSamples.splice(0), this._createMetricPayload(), this).catch(function (e) {\n      _this._log.warn('Unable to post metrics to Insights. Received error:', e);\n    });\n  };\n  /**\n   * Set the CallSid\n   * @param payload\n   */\n\n\n  Connection.prototype._setCallSid = function (payload) {\n    var callSid = payload.callsid;\n\n    if (!callSid) {\n      return;\n    }\n\n    this.parameters.CallSid = callSid;\n    this.mediaStream.callSid = callSid;\n  };\n  /**\n   * String representation of the {@link Connection} class.\n   * @private\n   */\n\n\n  Connection.toString = function () {\n    return '[Twilio.Connection class]';\n  };\n\n  return Connection;\n}(events_1.EventEmitter);\n\n(function (Connection) {\n  /**\n   * Possible states of the {@link Connection}.\n   */\n  var State;\n\n  (function (State) {\n    State[\"Closed\"] = \"closed\";\n    State[\"Connecting\"] = \"connecting\";\n    State[\"Open\"] = \"open\";\n    State[\"Pending\"] = \"pending\";\n    State[\"Reconnecting\"] = \"reconnecting\";\n    State[\"Ringing\"] = \"ringing\";\n  })(State = Connection.State || (Connection.State = {}));\n  /**\n   * Different issues that may have been experienced during a call, that can be\n   * reported to Twilio Insights via {@link Connection}.postFeedback().\n   */\n\n\n  var FeedbackIssue;\n\n  (function (FeedbackIssue) {\n    FeedbackIssue[\"AudioLatency\"] = \"audio-latency\";\n    FeedbackIssue[\"ChoppyAudio\"] = \"choppy-audio\";\n    FeedbackIssue[\"DroppedCall\"] = \"dropped-call\";\n    FeedbackIssue[\"Echo\"] = \"echo\";\n    FeedbackIssue[\"NoisyCall\"] = \"noisy-call\";\n    FeedbackIssue[\"OneWayAudio\"] = \"one-way-audio\";\n  })(FeedbackIssue = Connection.FeedbackIssue || (Connection.FeedbackIssue = {}));\n  /**\n   * A rating of call quality experienced during a call, to be reported to Twilio Insights\n   * via {@link Connection}.postFeedback().\n   */\n\n\n  var FeedbackScore;\n\n  (function (FeedbackScore) {\n    FeedbackScore[FeedbackScore[\"One\"] = 1] = \"One\";\n    FeedbackScore[FeedbackScore[\"Two\"] = 2] = \"Two\";\n    FeedbackScore[FeedbackScore[\"Three\"] = 3] = \"Three\";\n    FeedbackScore[FeedbackScore[\"Four\"] = 4] = \"Four\";\n    FeedbackScore[FeedbackScore[\"Five\"] = 5] = \"Five\";\n  })(FeedbackScore = Connection.FeedbackScore || (Connection.FeedbackScore = {}));\n  /**\n   * The directionality of the {@link Connection}, whether incoming or outgoing.\n   */\n\n\n  var CallDirection;\n\n  (function (CallDirection) {\n    CallDirection[\"Incoming\"] = \"INCOMING\";\n    CallDirection[\"Outgoing\"] = \"OUTGOING\";\n  })(CallDirection = Connection.CallDirection || (Connection.CallDirection = {}));\n  /**\n   * Valid audio codecs to use for the media connection.\n   */\n\n\n  var Codec;\n\n  (function (Codec) {\n    Codec[\"Opus\"] = \"opus\";\n    Codec[\"PCMU\"] = \"pcmu\";\n  })(Codec = Connection.Codec || (Connection.Codec = {}));\n  /**\n   * Possible ICE Gathering failures\n   */\n\n\n  var IceGatheringFailureReason;\n\n  (function (IceGatheringFailureReason) {\n    IceGatheringFailureReason[\"None\"] = \"none\";\n    IceGatheringFailureReason[\"Timeout\"] = \"timeout\";\n  })(IceGatheringFailureReason = Connection.IceGatheringFailureReason || (Connection.IceGatheringFailureReason = {}));\n  /**\n   * Possible media failures\n   */\n\n\n  var MediaFailure;\n\n  (function (MediaFailure) {\n    MediaFailure[\"ConnectionDisconnected\"] = \"ConnectionDisconnected\";\n    MediaFailure[\"ConnectionFailed\"] = \"ConnectionFailed\";\n    MediaFailure[\"IceGatheringFailed\"] = \"IceGatheringFailed\";\n    MediaFailure[\"LowBytes\"] = \"LowBytes\";\n  })(MediaFailure = Connection.MediaFailure || (Connection.MediaFailure = {}));\n})(Connection || (Connection = {}));\n\nfunction generateTempCallSid() {\n  return 'TJSxxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n    /* tslint:disable:no-bitwise */\n    var r = Math.random() * 16 | 0;\n    var v = c === 'x' ? r : r & 0x3 | 0x8;\n    /* tslint:enable:no-bitwise */\n\n    return v.toString(16);\n  });\n}\n\nexports.default = Connection;","map":{"version":3,"sources":["../../lib/twilio/connection.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @packageDocumentation\n * @module Voice\n * @publicapi\n * @internal\n */\nimport { EventEmitter } from 'events';\nimport Device from './device';\nimport DialtonePlayer from './dialtonePlayer';\nimport { GeneralErrors, InvalidArgumentError, MediaErrors, TwilioError } from './errors';\nimport Log from './log';\nimport { IceCandidate, RTCIceCandidate } from './rtc/icecandidate';\nimport RTCSample from './rtc/sample';\nimport RTCWarning from './rtc/warning';\nimport StatsMonitor from './statsMonitor';\nimport { isChrome } from './util';\n\nconst Backoff = require('backoff');\nconst C = require('./constants');\nconst { PeerConnection } = require('./rtc');\nconst { getPreferredCodecInfo } = require('./rtc/sdp');\n\n// Placeholders until we convert the respective files to TypeScript.\n/**\n * @private\n */\nexport type IAudioHelper = any;\n/**\n * @private\n */\nexport type IPStream = any;\n/**\n * @private\n */\nexport type IPeerConnection = any;\n/**\n * @private\n */\nexport type IPublisher = any;\n/**\n * @private\n */\nexport type ISound = any;\n\nconst BACKOFF_CONFIG = {\n  factor: 1.1,\n  initialDelay: 1,\n  maxDelay: 30000,\n  randomisationFactor: 0.5,\n};\n\nconst DTMF_INTER_TONE_GAP: number = 70;\nconst DTMF_PAUSE_DURATION: number = 500;\nconst DTMF_TONE_DURATION: number = 160;\n\nconst METRICS_BATCH_SIZE: number = 10;\nconst METRICS_DELAY: number = 5000;\n\nconst MEDIA_DISCONNECT_ERROR = {\n  disconnect: true,\n  info: {\n    code: 31003,\n    message: 'Connection with Twilio was interrupted.',\n    twilioError: new MediaErrors.ConnectionError(),\n  },\n};\n\nconst MULTIPLE_THRESHOLD_WARNING_NAMES: Record<string, Record<string, string>> = {\n  // The stat `packetsLostFraction` is monitored by two separate thresholds,\n  // `maxAverage` and `max`. Each threshold emits a different warning name.\n  packetsLostFraction: {\n    max: 'packet-loss',\n    maxAverage: 'packets-lost-fraction',\n  },\n};\n\nconst WARNING_NAMES: Record<string, string> = {\n  audioInputLevel: 'audio-input-level',\n  audioOutputLevel: 'audio-output-level',\n  bytesReceived: 'bytes-received',\n  bytesSent: 'bytes-sent',\n  jitter: 'jitter',\n  mos: 'mos',\n  rtt: 'rtt',\n};\n\nconst WARNING_PREFIXES: Record<string, string> = {\n  max: 'high-',\n  maxAverage: 'high-',\n  maxDuration: 'constant-',\n  min: 'low-',\n  minStandardDeviation: 'constant-',\n};\n\nlet hasBeenWarnedHandlers = false;\n\n/**\n * A {@link Connection} represents a media and signaling connection to a TwiML application.\n * @publicapi\n */\nclass Connection extends EventEmitter {\n  /**\n   * String representation of the {@link Connection} class.\n   * @private\n   */\n  static toString = () => '[Twilio.Connection class]';\n\n  /**\n   * Returns caller verification information about the caller.\n   * If no caller verification information is available this will return null.\n   */\n  readonly callerInfo: Connection.CallerInfo | null;\n\n  /**\n   * The custom parameters sent to (outgoing) or received by (incoming) the TwiML app.\n   */\n  readonly customParameters: Map<string, string>;\n\n  /**\n   * Whether this {@link Connection} is incoming or outgoing.\n   */\n  get direction(): Connection.CallDirection {\n    return this._direction;\n  }\n\n  /**\n   * Audio codec used for this {@link Connection}. Expecting {@link Connection.Codec} but\n   * will copy whatever we get from RTC stats.\n   */\n  get codec(): string {\n    return this._codec;\n  }\n\n  /**\n   * The MediaStream (Twilio PeerConnection) this {@link Connection} is using for\n   * media signaling.\n   * @private\n   */\n  mediaStream: IPeerConnection;\n\n  /**\n   * The temporary CallSid for this call, if it's outbound.\n   */\n  readonly outboundConnectionId?: string;\n\n  /**\n   * Call parameters received from Twilio for an incoming call.\n   */\n  parameters: Record<string, string> = { };\n\n  /**\n   * Audio codec used for this {@link Connection}. Expecting {@link Connection.Codec} but\n   * will copy whatever we get from RTC stats.\n   */\n  private _codec: string;\n\n  /**\n   * Whether this {@link Connection} is incoming or outgoing.\n   */\n  private readonly _direction: Connection.CallDirection;\n\n  /**\n   * The number of times input volume has been the same consecutively.\n   */\n  private _inputVolumeStreak: number = 0;\n\n  /**\n   * Whether the call has been answered.\n   */\n  private _isAnswered: boolean = false;\n\n  /**\n   * Whether the call has been cancelled.\n   */\n  private _isCancelled: boolean = false;\n\n  /**\n   * Whether or not the browser uses unified-plan SDP by default.\n   */\n  private readonly _isUnifiedPlanDefault: boolean | undefined;\n\n  /**\n   * The most recent public input volume value. 0 -> 1 representing -100 to -30 dB.\n   */\n  private _latestInputVolume: number = 0;\n\n  /**\n   * The most recent public output volume value. 0 -> 1 representing -100 to -30 dB.\n   */\n  private _latestOutputVolume: number = 0;\n\n  /**\n   * An instance of Logger to use.\n   */\n  private _log: Log = Log.getInstance();\n\n  /**\n   * An instance of Backoff for media reconnection\n   */\n  private _mediaReconnectBackoff: any;\n\n  /**\n   * Timestamp for the initial media reconnection\n   */\n  private _mediaReconnectStartTime: number;\n\n  /**\n   * A batch of metrics samples to send to Insights. Gets cleared after\n   * each send and appended to on each new sample.\n   */\n  private readonly _metricsSamples: Connection.CallMetrics[] = [];\n\n  /**\n   * An instance of StatsMonitor.\n   */\n  private readonly _monitor: StatsMonitor;\n\n  /**\n   * The number of times output volume has been the same consecutively.\n   */\n  private _outputVolumeStreak: number = 0;\n\n  /**\n   * An instance of EventPublisher.\n   */\n  private readonly _publisher: IPublisher;\n\n  /**\n   * A Map of Sounds to play.\n   */\n  private readonly _soundcache: Map<Device.SoundName, ISound> = new Map();\n\n  /**\n   * State of the {@link Connection}.\n   */\n  private _status: Connection.State = Connection.State.Pending;\n\n  /**\n   * TwiML params for the call. May be set for either outgoing or incoming calls.\n   */\n  private readonly message: Record<string, string>;\n\n  /**\n   * Options passed to this {@link Connection}.\n   */\n  private options: Connection.Options = {\n    enableRingingState: false,\n    mediaStreamFactory: PeerConnection,\n    offerSdp: null,\n    shouldPlayDisconnect: () => true,\n  };\n\n  /**\n   * The PStream instance to use for Twilio call signaling.\n   */\n  private readonly pstream: IPStream;\n\n  /**\n   * Whether the {@link Connection} should send a hangup on disconnect.\n   */\n  private sendHangup: boolean = true;\n\n  /**\n   * @constructor\n   * @private\n   * @param config - Mandatory configuration options\n   * @param [options] - Optional settings\n   */\n  constructor(config: Connection.Config, options?: Connection.Options) {\n    super();\n\n    this._isUnifiedPlanDefault = config.isUnifiedPlanDefault;\n    this._soundcache = config.soundcache;\n    this.message = options && options.twimlParams || { };\n    this.customParameters = new Map(\n      Object.entries(this.message).map(([key, val]: [string, any]): [string, string] => [key, String(val)]));\n\n    Object.assign(this.options, options);\n\n    if (this.options.callParameters) {\n      this.parameters = this.options.callParameters;\n    }\n\n    this._direction = this.parameters.CallSid ? Connection.CallDirection.Incoming : Connection.CallDirection.Outgoing;\n\n    if (this._direction === Connection.CallDirection.Incoming && this.parameters) {\n      this.callerInfo = this.parameters.StirStatus\n        ? { isVerified: this.parameters.StirStatus === 'TN-Validation-Passed-A' }\n        : null;\n    } else {\n      this.callerInfo = null;\n    }\n\n    this._mediaReconnectBackoff = Backoff.exponential(BACKOFF_CONFIG);\n    this._mediaReconnectBackoff.on('ready', () => this.mediaStream.iceRestart());\n\n    // temporary call sid to be used for outgoing calls\n    this.outboundConnectionId = generateTempCallSid();\n\n    const publisher = this._publisher = config.publisher;\n\n    if (this._direction === Connection.CallDirection.Incoming) {\n      publisher.info('connection', 'incoming', null, this);\n    } else {\n      publisher.info('connection', 'outgoing', { preflight: this.options.preflight }, this);\n    }\n\n    const monitor = this._monitor = new (this.options.StatsMonitor || StatsMonitor)();\n    monitor.on('sample', this._onRTCSample);\n\n    // First 20 seconds or so are choppy, so let's not bother with these warnings.\n    monitor.disableWarnings();\n    setTimeout(() => monitor.enableWarnings(), METRICS_DELAY);\n\n    monitor.on('warning', (data: RTCWarning, wasCleared?: boolean) => {\n      if (data.name === 'bytesSent' || data.name === 'bytesReceived') {\n        this._onMediaFailure(Connection.MediaFailure.LowBytes);\n      }\n      this._reemitWarning(data, wasCleared);\n    });\n    monitor.on('warning-cleared', (data: RTCWarning) => {\n      this._reemitWarningCleared(data);\n    });\n\n    this.mediaStream = new (this.options.MediaStream || this.options.mediaStreamFactory)\n      (config.audioHelper, config.pstream, config.getUserMedia, {\n        codecPreferences: this.options.codecPreferences,\n        dscp: this.options.dscp,\n        enableIceRestart: this.options.enableIceRestart,\n        forceAggressiveIceNomination: this.options.forceAggressiveIceNomination,\n        isUnifiedPlan: this._isUnifiedPlanDefault,\n        maxAverageBitrate: this.options.maxAverageBitrate,\n        preflight: this.options.preflight,\n      });\n\n    this.on('volume', (inputVolume: number, outputVolume: number): void => {\n      this._inputVolumeStreak = this._checkVolume(\n        inputVolume, this._inputVolumeStreak, this._latestInputVolume, 'input');\n      this._outputVolumeStreak = this._checkVolume(\n        outputVolume, this._outputVolumeStreak, this._latestOutputVolume, 'output');\n      this._latestInputVolume = inputVolume;\n      this._latestOutputVolume = outputVolume;\n    });\n\n    this.mediaStream.onvolume = (inputVolume: number, outputVolume: number,\n                                 internalInputVolume: number, internalOutputVolume: number) => {\n      // (rrowland) These values mock the 0 -> 32767 format used by legacy getStats. We should look into\n      // migrating to a newer standard, either 0.0 -> linear or -127 to 0 in dB, matching the range\n      // chosen below.\n      monitor.addVolumes((internalInputVolume / 255) * 32767, (internalOutputVolume / 255) * 32767);\n\n      // (rrowland) 0.0 -> 1.0 linear\n      this.emit('volume', inputVolume, outputVolume);\n    };\n\n    this.mediaStream.ondtlstransportstatechange = (state: string): void => {\n      const level = state === 'failed' ? 'error' : 'debug';\n      this._publisher.post(level, 'dtls-transport-state', state, null, this);\n    };\n\n    this.mediaStream.onpcconnectionstatechange = (state: string): void => {\n      let level = 'debug';\n      const dtlsTransport = this.mediaStream.getRTCDtlsTransport();\n\n      if (state === 'failed') {\n        level = dtlsTransport && dtlsTransport.state === 'failed' ? 'error' : 'warning';\n      }\n      this._publisher.post(level, 'pc-connection-state', state, null, this);\n    };\n\n    this.mediaStream.onicecandidate = (candidate: RTCIceCandidate): void => {\n      const payload = new IceCandidate(candidate).toPayload();\n      this._publisher.debug('ice-candidate', 'ice-candidate', payload, this);\n    };\n\n    this.mediaStream.onselectedcandidatepairchange = (pair: RTCIceCandidatePair): void => {\n      const localCandidatePayload = new IceCandidate(pair.local).toPayload();\n      const remoteCandidatePayload = new IceCandidate(pair.remote, true).toPayload();\n\n      this._publisher.debug('ice-candidate', 'selected-ice-candidate-pair', {\n        local_candidate: localCandidatePayload,\n        remote_candidate: remoteCandidatePayload,\n      }, this);\n    };\n\n    this.mediaStream.oniceconnectionstatechange = (state: string): void => {\n      const level = state === 'failed' ? 'error' : 'debug';\n      this._publisher.post(level, 'ice-connection-state', state, null, this);\n    };\n\n    this.mediaStream.onicegatheringfailure = (type: Connection.IceGatheringFailureReason): void => {\n      this._publisher.warn('ice-gathering-state', type, null, this);\n      this._onMediaFailure(Connection.MediaFailure.IceGatheringFailed);\n    };\n\n    this.mediaStream.onicegatheringstatechange = (state: string): void => {\n      this._publisher.debug('ice-gathering-state', state, null, this);\n    };\n\n    this.mediaStream.onsignalingstatechange = (state: string): void => {\n      this._publisher.debug('signaling-state', state, null, this);\n    };\n\n    this.mediaStream.ondisconnected = (msg: string): void => {\n      this._log.info(msg);\n      this._publisher.warn('network-quality-warning-raised', 'ice-connectivity-lost', {\n        message: msg,\n      }, this);\n      this.emit('warning', 'ice-connectivity-lost');\n\n      this._onMediaFailure(Connection.MediaFailure.ConnectionDisconnected);\n    };\n\n    this.mediaStream.onfailed = (msg: string): void => {\n      this._onMediaFailure(Connection.MediaFailure.ConnectionFailed);\n    };\n\n    this.mediaStream.onconnected = (): void => {\n      // First time mediaStream is connected, but ICE Gathering issued an ICE restart and succeeded.\n      if (this._status === Connection.State.Reconnecting) {\n        this._onMediaReconnected();\n      }\n    };\n\n    this.mediaStream.onreconnected = (msg: string): void => {\n      this._log.info(msg);\n      this._publisher.info('network-quality-warning-cleared', 'ice-connectivity-lost', {\n        message: msg,\n      }, this);\n      this.emit('warning-cleared', 'ice-connectivity-lost');\n      this._onMediaReconnected();\n    };\n\n    this.mediaStream.onerror = (e: any): void => {\n      if (e.disconnect === true) {\n        this._disconnect(e.info && e.info.message);\n      }\n      const error: Connection.Error = {\n        code: e.info.code,\n        connection: this,\n        info: e.info,\n        message: e.info.message || 'Error with mediastream',\n        twilioError: e.info.twilioError,\n      };\n\n      this._log.error('Received an error from MediaStream:', e);\n      this.emit('error', error);\n    };\n\n    this.mediaStream.onopen = () => {\n      // NOTE(mroberts): While this may have been happening in previous\n      // versions of Chrome, since Chrome 45 we have seen the\n      // PeerConnection's onsignalingstatechange handler invoked multiple\n      // times in the same signalingState 'stable'. When this happens, we\n      // invoke this onopen function. If we invoke it twice without checking\n      // for _status 'open', we'd accidentally close the PeerConnection.\n      //\n      // See <https://code.google.com/p/webrtc/issues/detail?id=4996>.\n      if (this._status === Connection.State.Open || this._status === Connection.State.Reconnecting) {\n        return;\n      } else if (this._status === Connection.State.Ringing || this._status === Connection.State.Connecting) {\n        this.mute(false);\n        this._maybeTransitionToOpen();\n      } else {\n        // call was probably canceled sometime before this\n        this.mediaStream.close();\n      }\n    };\n\n    this.mediaStream.onclose = () => {\n      this._status = Connection.State.Closed;\n      if (this.options.shouldPlayDisconnect && this.options.shouldPlayDisconnect()\n        // Don't play disconnect sound if this was from a cancel event. i.e. the call\n        // was ignored or hung up even before it was answered.\n        && !this._isCancelled) {\n\n        this._soundcache.get(Device.SoundName.Disconnect).play();\n      }\n\n      monitor.disable();\n      this._publishMetrics();\n\n      if (!this._isCancelled) {\n        this.emit('disconnect', this);\n      }\n    };\n\n    this.pstream = config.pstream;\n    this.pstream.on('cancel', this._onCancel);\n    this.pstream.on('ringing', this._onRinging);\n    this.pstream.on('transportClose', this._onTransportClose);\n\n    this.on('error', error => {\n      this._publisher.error('connection', 'error', {\n        code: error.code, message: error.message,\n      }, this);\n\n      if (this.pstream && this.pstream.status === 'disconnected') {\n        this._cleanupEventListeners();\n      }\n    });\n\n    this.on('disconnect', () => {\n      this._cleanupEventListeners();\n    });\n  }\n\n  /**\n   * Get the real CallSid. Returns null if not present or is a temporary call sid.\n   * @deprecated\n   * @private\n   */\n  _getRealCallSid(): string | null {\n    this._log.warn('_getRealCallSid is deprecated and will be removed in 2.0.');\n    return /^TJ/.test(this.parameters.CallSid) ? null : this.parameters.CallSid;\n  }\n\n  /**\n   * Get the temporary CallSid.\n   * @deprecated\n   * @private\n   */\n  _getTempCallSid(): string | undefined {\n    this._log.warn('_getTempCallSid is deprecated and will be removed in 2.0. \\\n                    Please use outboundConnectionId instead.');\n    return this.outboundConnectionId;\n  }\n\n  /**\n   * Set the audio input tracks from a given stream.\n   * @param stream\n   * @private\n   */\n  _setInputTracksFromStream(stream: MediaStream | null): Promise<void> {\n    return this.mediaStream.setInputTracksFromStream(stream);\n  }\n\n  /**\n   * Set the audio output sink IDs.\n   * @param sinkIds\n   * @private\n   */\n  _setSinkIds(sinkIds: string[]): Promise<void> {\n    return this.mediaStream._setSinkIds(sinkIds);\n  }\n\n  /**\n   * Accept the incoming {@link Connection}.\n   * @param [audioConstraints]\n   * @param [rtcConfiguration] - An RTCConfiguration to override the one set in `Device.setup`.\n   */\n  accept(audioConstraints?: MediaTrackConstraints | boolean, rtcConfiguration?: RTCConfiguration): void;\n  /**\n   * @deprecated - Set a handler for the {@link acceptEvent}\n   * @param handler\n   */\n  accept(handler: (connection: this) => void): void;\n  accept(handlerOrConstraints?: ((connection: this) => void) | MediaTrackConstraints | boolean,\n         rtcConfiguration?: RTCConfiguration): void {\n    if (typeof handlerOrConstraints === 'function') {\n      this._addHandler('accept', handlerOrConstraints);\n      return;\n    }\n\n    if (this._status !== Connection.State.Pending) {\n      return;\n    }\n\n    const audioConstraints = handlerOrConstraints || this.options.audioConstraints;\n    this._status = Connection.State.Connecting;\n\n    const connect = () => {\n      if (this._status !== Connection.State.Connecting) {\n        // call must have been canceled\n        this._cleanupEventListeners();\n        this.mediaStream.close();\n        return;\n      }\n\n      const onAnswer = (pc: RTCPeerConnection) => {\n        // Report that the call was answered, and directionality\n        const eventName = this._direction === Connection.CallDirection.Incoming\n          ? 'accepted-by-local'\n          : 'accepted-by-remote';\n        this._publisher.info('connection', eventName, null, this);\n\n        // Report the preferred codec and params as they appear in the SDP\n        const { codecName, codecParams } = getPreferredCodecInfo(this.mediaStream.version.getSDP());\n        this._publisher.info('settings', 'codec', {\n          codec_params: codecParams,\n          selected_codec: codecName,\n        }, this);\n\n        // Enable RTC monitoring\n        this._monitor.enable(pc);\n      };\n\n      const sinkIds = typeof this.options.getSinkIds === 'function' && this.options.getSinkIds();\n      if (Array.isArray(sinkIds)) {\n        this.mediaStream._setSinkIds(sinkIds).catch(() => {\n          // (rrowland) We don't want this to throw to console since the customer\n          // can't control this. This will most commonly be rejected on browsers\n          // that don't support setting sink IDs.\n        });\n      }\n\n      this.pstream.addListener('hangup', this._onHangup);\n\n      rtcConfiguration = rtcConfiguration || this.options.rtcConfiguration;\n\n      if (this._direction === Connection.CallDirection.Incoming) {\n        this._isAnswered = true;\n        this.mediaStream.answerIncomingCall(this.parameters.CallSid, this.options.offerSdp,\n          this.options.rtcConstraints, rtcConfiguration, onAnswer);\n      } else {\n        const params = Array.from(this.customParameters.entries()).map(pair =>\n         `${encodeURIComponent(pair[0])}=${encodeURIComponent(pair[1])}`).join('&');\n        this.pstream.once('answer', this._onAnswer.bind(this));\n        this.mediaStream.makeOutgoingCall(this.pstream.token, params, this.outboundConnectionId,\n          this.options.rtcConstraints, rtcConfiguration, onAnswer);\n      }\n    };\n\n    if (this.options.beforeAccept) {\n      this.options.beforeAccept(this);\n    }\n\n    const inputStream = typeof this.options.getInputStream === 'function' && this.options.getInputStream();\n\n    const promise = inputStream\n      ? this.mediaStream.setInputTracksFromStream(inputStream)\n      : this.mediaStream.openWithConstraints(audioConstraints);\n\n    promise.then(() => {\n      this._publisher.info('get-user-media', 'succeeded', {\n        data: { audioConstraints },\n      }, this);\n\n      connect();\n    }, (error: Record<string, any>) => {\n      let message;\n      let code;\n\n      if (error.code === 31208\n        || ['PermissionDeniedError', 'NotAllowedError'].indexOf(error.name) !== -1) {\n        code = 31208;\n        message = 'User denied access to microphone, or the web browser did not allow microphone '\n          + 'access at this address.';\n        this._publisher.error('get-user-media', 'denied', {\n          data: {\n            audioConstraints,\n            error,\n          },\n        }, this);\n      } else {\n        code = 31201;\n        message = `Error occurred while accessing microphone: ${error.name}${error.message\n          ? ` (${error.message})`\n          : ''}`;\n\n        this._publisher.error('get-user-media', 'failed', {\n          data: {\n            audioConstraints,\n            error,\n          },\n        }, this);\n      }\n\n      this._disconnect();\n      this.emit('error', { message, code });\n    });\n  }\n\n  /**\n   * @deprecated - Ignore the incoming {@link Connection}.\n   */\n  cancel(): void;\n  /**\n   * @deprecated - Set a handler for the {@link cancelEvent}\n   */\n  cancel(handler: () => void): void;\n  cancel(handler?: () => void): void {\n    this._log.warn('.cancel() is deprecated. Please use .ignore() instead.');\n\n    if (handler) {\n      this.ignore(handler);\n    } else {\n      this.ignore();\n    }\n  }\n\n  /**\n   * Disconnect from the {@link Connection}.\n   */\n  disconnect(): void;\n  /**\n   * @deprecated - Set a handler for the {@link disconnectEvent}\n   */\n  disconnect(handler: (connection: this) => void): void;\n  disconnect(handler?: (connection: this) => void): void {\n    if (typeof handler === 'function') {\n      this._addHandler('disconnect', handler);\n      return;\n    }\n    this._disconnect();\n  }\n\n  /**\n   * @deprecated - Set a handler for the {@link errorEvent}\n   */\n  error(handler: (error: Connection.Error) => void): void {\n    if (typeof handler === 'function') {\n      this._addHandler('error', handler);\n    }\n  }\n\n  /**\n   * Get the local MediaStream, if set.\n   */\n  getLocalStream(): MediaStream | undefined {\n    return this.mediaStream && this.mediaStream.stream;\n  }\n\n  /**\n   * Get the remote MediaStream, if set.\n   */\n  getRemoteStream(): MediaStream | undefined {\n    return this.mediaStream && this.mediaStream._remoteStream;\n  }\n\n  /**\n   * Ignore the incoming {@link Connection}.\n   */\n  ignore(): void;\n  /**\n   * @deprecated - Set a handler for the {@link cancelEvent}\n   */\n  ignore(handler: () => void): void;\n  ignore(handler?: () => void): void {\n    if (typeof handler === 'function') {\n      this._addHandler('cancel', handler);\n      return;\n    }\n\n    if (this._status !== Connection.State.Pending) {\n      return;\n    }\n\n    this._status = Connection.State.Closed;\n    this.emit('cancel');\n    this.mediaStream.ignore(this.parameters.CallSid);\n    this._publisher.info('connection', 'ignored-by-local', null, this);\n  }\n\n  /**\n   * Check if connection is muted\n   */\n  isMuted(): boolean {\n    return this.mediaStream.isMuted;\n  }\n\n  /**\n   * Mute incoming audio.\n   * @param shouldMute - Whether the incoming audio should be muted. Defaults to true.\n   */\n  mute(shouldMute?: boolean): void;\n  /**\n   * @deprecated - Set a handler for the {@link muteEvent}\n   */\n  mute(handler: (isMuted: boolean, connection: this) => void): void;\n  mute(shouldMute: boolean | ((isMuted: boolean, connection: this) => void) = true): void {\n    if (typeof shouldMute === 'function') {\n      this._addHandler('mute', shouldMute);\n      return;\n    }\n\n    const wasMuted = this.mediaStream.isMuted;\n    this.mediaStream.mute(shouldMute);\n\n    const isMuted = this.mediaStream.isMuted;\n    if (wasMuted !== isMuted) {\n      this._publisher.info('connection', isMuted ? 'muted' : 'unmuted', null, this);\n      this.emit('mute', isMuted, this);\n    }\n  }\n\n  /**\n   * Post an event to Endpoint Analytics indicating that the end user\n   *   has given call quality feedback. Called without a score, this\n   *   will report that the customer declined to give feedback.\n   * @param score - The end-user's rating of the call; an\n   *   integer 1 through 5. Or undefined if the user declined to give\n   *   feedback.\n   * @param issue - The primary issue the end user\n   *   experienced on the call. Can be: ['one-way-audio', 'choppy-audio',\n   *   'dropped-call', 'audio-latency', 'noisy-call', 'echo']\n   */\n  postFeedback(score?: Connection.FeedbackScore, issue?: Connection.FeedbackIssue): Promise<void> {\n    if (typeof score === 'undefined' || score === null) {\n      return this._postFeedbackDeclined();\n    }\n\n    if (!Object.values(Connection.FeedbackScore).includes(score)) {\n      throw new InvalidArgumentError(`Feedback score must be one of: ${Object.values(Connection.FeedbackScore)}`);\n    }\n\n    if (typeof issue !== 'undefined' && issue !== null && !Object.values(Connection.FeedbackIssue).includes(issue)) {\n      throw new InvalidArgumentError(`Feedback issue must be one of: ${Object.values(Connection.FeedbackIssue)}`);\n    }\n\n    return this._publisher.info('feedback', 'received', {\n      issue_name: issue,\n      quality_score: score,\n    }, this, true);\n  }\n\n  /**\n   * Reject the incoming {@link Connection}.\n   */\n  reject(): void;\n  /**\n   * @deprecated - Set a handler for the {@link rejectEvent}\n   */\n  reject(handler: () => void): void;\n  reject(handler?: () => void): void {\n    if (typeof handler === 'function') {\n      this._addHandler('reject', handler);\n      return;\n    }\n\n    if (this._status !== Connection.State.Pending) {\n      return;\n    }\n\n    this.pstream.reject(this.parameters.CallSid);\n    this._status = Connection.State.Closed;\n    this.emit('reject');\n    this.mediaStream.reject(this.parameters.CallSid);\n    this._publisher.info('connection', 'rejected-by-local', null, this);\n  }\n\n  /**\n   * Send a string of digits.\n   * @param digits\n   */\n  sendDigits(digits: string): void {\n    if (digits.match(/[^0-9*#w]/)) {\n      throw new InvalidArgumentError('Illegal character passed into sendDigits');\n    }\n\n    const sequence: string[] = [];\n    digits.split('').forEach((digit: string) => {\n      let dtmf = (digit !== 'w') ? `dtmf${digit}` : '';\n      if (dtmf === 'dtmf*') { dtmf = 'dtmfs'; }\n      if (dtmf === 'dtmf#') { dtmf = 'dtmfh'; }\n      sequence.push(dtmf);\n    });\n\n    // Binds soundCache to be used in recursion until all digits have been played.\n    (function playNextDigit(soundCache, dialtonePlayer) {\n      const digit: string | undefined = sequence.shift();\n\n      if (digit) {\n        if (dialtonePlayer) {\n          dialtonePlayer.play(digit);\n        } else {\n          soundCache.get(digit as Device.SoundName).play();\n        }\n      }\n\n      if (sequence.length) {\n        setTimeout(playNextDigit.bind(null, soundCache), 200);\n      }\n    })(this._soundcache, this.options.dialtonePlayer);\n\n    const dtmfSender = this.mediaStream.getOrCreateDTMFSender();\n\n    function insertDTMF(dtmfs: string[]) {\n      if (!dtmfs.length) { return; }\n      const dtmf: string | undefined = dtmfs.shift();\n\n      if (dtmf && dtmf.length) {\n        dtmfSender.insertDTMF(dtmf, DTMF_TONE_DURATION, DTMF_INTER_TONE_GAP);\n      }\n\n      setTimeout(insertDTMF.bind(null, dtmfs), DTMF_PAUSE_DURATION);\n    }\n\n    if (dtmfSender) {\n      if (!('canInsertDTMF' in dtmfSender) || dtmfSender.canInsertDTMF) {\n        this._log.info('Sending digits using RTCDTMFSender');\n        // NOTE(mroberts): We can't just map 'w' to ',' since\n        // RTCDTMFSender's pause duration is 2 s and Twilio's is more\n        // like 500 ms. Instead, we will fudge it with setTimeout.\n        insertDTMF(digits.split('w'));\n        return;\n      }\n\n      this._log.info('RTCDTMFSender cannot insert DTMF');\n    }\n\n    // send pstream message to send DTMF\n    this._log.info('Sending digits over PStream');\n\n    if (this.pstream !== null && this.pstream.status !== 'disconnected') {\n      this.pstream.dtmf(this.parameters.CallSid, digits);\n    } else {\n      const error = {\n        code: 31000,\n        connection: this,\n        message: 'Could not send DTMF: Signaling channel is disconnected',\n      };\n      this.emit('error', error);\n    }\n  }\n\n  /**\n   * Get the current {@link Connection} status.\n   */\n  status(): Connection.State {\n    return this._status;\n  }\n\n  /**\n   * String representation of {@link Connection} instance.\n   * @private\n   */\n  toString = () => '[Twilio.Connection instance]';\n\n  /**\n   * @deprecated - Unmute the {@link Connection}.\n   */\n  unmute(): void {\n    this._log.warn('.unmute() is deprecated. Please use .mute(false) to unmute a call instead.');\n    this.mute(false);\n  }\n\n  /**\n   * @deprecated - Set a handler for the {@link volumeEvent}\n   * @param handler\n   */\n  volume(handler: (inputVolume: number, outputVolume: number) => void): void {\n    if (!window || (!(window as any).AudioContext && !(window as any).webkitAudioContext)) {\n      this._log.warn('This browser does not support Connection.volume');\n    }\n\n    this._addHandler('volume', handler);\n  }\n\n  /**\n   * Add a handler for an EventEmitter and emit a deprecation warning on first call.\n   * @param eventName - Name of the event\n   * @param handler - A handler to call when the event is emitted\n   */\n  private _addHandler(eventName: string, handler: (...args: any[]) => any): this {\n    if (!hasBeenWarnedHandlers) {\n      this._log.warn(`Connection callback handlers (accept, cancel, disconnect, error, ignore, mute, reject,\n        volume) have been deprecated and will be removed in the next breaking release. Instead, the EventEmitter \\\n        interface can be used to set event listeners. Example: connection.on('${eventName}', handler)`);\n      hasBeenWarnedHandlers = true;\n    }\n\n    this.addListener(eventName, handler);\n    return this;\n  }\n\n  /**\n   * Check the volume passed, emitting a warning if one way audio is detected or cleared.\n   * @param currentVolume - The current volume for this direction\n   * @param streakFieldName - The name of the field on the {@link Connection} object that tracks how many times the\n   *   current value has been repeated consecutively.\n   * @param lastValueFieldName - The name of the field on the {@link Connection} object that tracks the most recent\n   *   volume for this direction\n   * @param direction - The directionality of this audio track, either 'input' or 'output'\n   * @returns The current streak; how many times in a row the same value has been polled.\n   */\n  private _checkVolume(currentVolume: number, currentStreak: number,\n                       lastValue: number, direction: 'input'|'output'): number {\n    const wasWarningRaised: boolean = currentStreak >= 10;\n    let newStreak: number = 0;\n\n    if (lastValue === currentVolume) {\n      newStreak = currentStreak;\n    }\n\n    if (newStreak >= 10) {\n      this._emitWarning('audio-level-', `constant-audio-${direction}-level`, 10, newStreak, false);\n    } else if (wasWarningRaised) {\n      this._emitWarning('audio-level-', `constant-audio-${direction}-level`, 10, newStreak, true);\n    }\n\n    return newStreak;\n  }\n\n  /**\n   * Clean up event listeners.\n   */\n  private _cleanupEventListeners(): void {\n    const cleanup = () => {\n      if (!this.pstream) { return; }\n\n      this.pstream.removeListener('answer', this._onAnswer);\n      this.pstream.removeListener('cancel', this._onCancel);\n      this.pstream.removeListener('hangup', this._onHangup);\n      this.pstream.removeListener('ringing', this._onRinging);\n      this.pstream.removeListener('transportClose', this._onTransportClose);\n    };\n\n    // This is kind of a hack, but it lets us avoid rewriting more code.\n    // Basically, there's a sequencing problem with the way PeerConnection raises\n    // the\n    //\n    //   Cannot establish connection. Client is disconnected\n    //\n    // error in Connection#accept. It calls PeerConnection#onerror, which emits\n    // the error event on Connection. An error handler on Connection then calls\n    // cleanupEventListeners, but then control returns to Connection#accept. It's\n    // at this point that we add a listener for the answer event that never gets\n    // removed. setTimeout will allow us to rerun cleanup again, _after_\n    // Connection#accept returns.\n    cleanup();\n    setTimeout(cleanup, 0);\n  }\n\n  /**\n   * Create the payload wrapper for a batch of metrics to be sent to Insights.\n   */\n  private _createMetricPayload(): Partial<Record<string, string|boolean>> {\n    const payload: Partial<Record<string, string|boolean>> = {\n      call_sid: this.parameters.CallSid,\n      dscp: !!this.options.dscp,\n      sdk_version: C.RELEASE_VERSION,\n      selected_region: this.options.selectedRegion,\n    };\n\n    if (this.options.gateway) {\n      payload.gateway = this.options.gateway;\n    }\n\n    if (this.options.region) {\n      payload.region = this.options.region;\n    }\n\n    payload.direction = this._direction;\n    return payload;\n  }\n\n  /**\n   * Disconnect the {@link Connection}.\n   * @param message - A message explaining why the {@link Connection} is being disconnected.\n   * @param wasRemote - Whether the disconnect was triggered locally or remotely.\n   */\n  private _disconnect(message?: string | null, wasRemote?: boolean): void {\n    message = typeof message === 'string' ? message : null;\n\n    if (this._status !== Connection.State.Open\n        && this._status !== Connection.State.Connecting\n        && this._status !== Connection.State.Reconnecting\n        && this._status !== Connection.State.Ringing) {\n      return;\n    }\n\n    this._log.info('Disconnecting...');\n\n    // send pstream hangup message\n    if (this.pstream !== null && this.pstream.status !== 'disconnected' && this.sendHangup) {\n      const callsid: string | undefined = this.parameters.CallSid || this.outboundConnectionId;\n      if (callsid) {\n        this.pstream.hangup(callsid, message);\n      }\n    }\n\n    this._cleanupEventListeners();\n    this.mediaStream.close();\n\n    if (!wasRemote) {\n      this._publisher.info('connection', 'disconnected-by-local', null, this);\n    }\n  }\n\n  private _emitWarning = (groupPrefix: string, warningName: string, threshold: number,\n                          value: number|number[], wasCleared?: boolean, warningData?: RTCWarning): void => {\n    const groupSuffix = wasCleared ? '-cleared' : '-raised';\n    const groupName = `${groupPrefix}warning${groupSuffix}`;\n\n    // Ignore constant input if the Connection is muted (Expected)\n    if (warningName === 'constant-audio-input-level' && this.isMuted()) {\n      return;\n    }\n\n    let level = wasCleared ? 'info' : 'warning';\n\n    // Avoid throwing false positives as warnings until we refactor volume metrics\n    if (warningName === 'constant-audio-output-level') {\n      level = 'info';\n    }\n\n    const payloadData: Record<string, any> = { threshold };\n\n    if (value) {\n      if (value instanceof Array) {\n        payloadData.values = value.map((val: any) => {\n          if (typeof val === 'number') {\n            return Math.round(val * 100) / 100;\n          }\n\n          return value;\n        });\n      } else {\n        payloadData.value = value;\n      }\n    }\n\n    this._publisher.post(level, groupName, warningName, { data: payloadData }, this);\n\n    if (warningName !== 'constant-audio-output-level') {\n      const emitName = wasCleared ? 'warning-cleared' : 'warning';\n      this.emit(emitName, warningName, warningData && !wasCleared ? warningData : null);\n    }\n  }\n\n  /**\n   * Transition to {@link ConnectionStatus.Open} if criteria is met.\n   */\n  private _maybeTransitionToOpen(): void {\n    if (this.mediaStream && this.mediaStream.status === 'open' && this._isAnswered) {\n      this._status = Connection.State.Open;\n      this.emit('accept', this);\n    }\n  }\n\n  /**\n   * Called when the {@link Connection} is answered.\n   * @param payload\n   */\n  private _onAnswer = (payload: Record<string, any>): void => {\n    // answerOnBridge=false will send a 183 which we need to catch in _onRinging when\n    // the enableRingingState flag is disabled. In that case, we will receive a 200 after\n    // the callee accepts the call firing a second `accept` event if we don't\n    // short circuit here.\n    if (this._isAnswered) {\n      return;\n    }\n\n    this._setCallSid(payload);\n    this._isAnswered = true;\n    this._maybeTransitionToOpen();\n  }\n\n  /**\n   * Called when the {@link Connection} is cancelled.\n   * @param payload\n   */\n  private _onCancel = (payload: Record<string, any>): void => {\n    // (rrowland) Is this check necessary? Verify, and if so move to pstream / VSP module.\n    const callsid = payload.callsid;\n    if (this.parameters.CallSid === callsid) {\n      this._isCancelled = true;\n      this._publisher.info('connection', 'cancel', null, this);\n      this._cleanupEventListeners();\n      this.mediaStream.close();\n\n      this._status = Connection.State.Closed;\n      this.emit('cancel');\n      this.pstream.removeListener('cancel', this._onCancel);\n    }\n  }\n\n  /**\n   * Called when the {@link Connection} is hung up.\n   * @param payload\n   */\n  private _onHangup = (payload: Record<string, any>): void => {\n    /**\n     *  see if callsid passed in message matches either callsid or outbound id\n     *  connection should always have either callsid or outbound id\n     *  if no callsid passed hangup anyways\n     */\n    if (payload.callsid && (this.parameters.CallSid || this.outboundConnectionId)) {\n      if (payload.callsid !== this.parameters.CallSid\n          && payload.callsid !== this.outboundConnectionId) {\n        return;\n      }\n    } else if (payload.callsid) {\n      // hangup is for another connection\n      return;\n    }\n\n    this._log.info('Received HANGUP from gateway');\n    if (payload.error) {\n      const error = {\n        code: payload.error.code || 31000,\n        connection: this,\n        message: payload.error.message || 'Error sent from gateway in HANGUP',\n        twilioError: new GeneralErrors.ConnectionError(),\n      };\n      this._log.error('Received an error from the gateway:', error);\n      this.emit('error', error);\n    }\n    this.sendHangup = false;\n    this._publisher.info('connection', 'disconnected-by-remote', null, this);\n    this._disconnect(null, true);\n    this._cleanupEventListeners();\n  }\n\n  /**\n   * Called when there is a media failure.\n   * Manages all media-related states and takes action base on the states\n   * @param type - Type of media failure\n   */\n  private _onMediaFailure = (type: Connection.MediaFailure): void => {\n    const {\n      ConnectionDisconnected, ConnectionFailed, IceGatheringFailed, LowBytes,\n    } = Connection.MediaFailure;\n\n    // These types signifies the end of a single ICE cycle\n    const isEndOfIceCycle = type === ConnectionFailed || type === IceGatheringFailed;\n\n    // Default behavior on ice failures with disabled ice restart.\n    if ((!this.options.enableIceRestart && isEndOfIceCycle)\n\n      // All browsers except chrome doesn't update pc.iceConnectionState and pc.connectionState\n      // after issuing an ICE Restart, which we use to determine if ICE Restart is complete.\n      // Since we cannot detect if ICE Restart is complete, we will not retry.\n      || (!isChrome(window, window.navigator) && type === ConnectionFailed)) {\n\n        return this.mediaStream.onerror(MEDIA_DISCONNECT_ERROR);\n    }\n\n    // Ignore any other type of media failure if ice restart is disabled\n    if (!this.options.enableIceRestart) {\n      return;\n    }\n\n    // Ignore subsequent requests if ice restart is in progress\n    if (this._status === Connection.State.Reconnecting) {\n\n      // This is a retry. Previous ICE Restart failed\n      if (isEndOfIceCycle) {\n\n        // We already exceeded max retry time.\n        if (Date.now() - this._mediaReconnectStartTime > BACKOFF_CONFIG.maxDelay) {\n          this._log.info('Exceeded max ICE retries');\n          return this.mediaStream.onerror(MEDIA_DISCONNECT_ERROR);\n        }\n\n        // Issue ICE restart with backoff\n        this._mediaReconnectBackoff.backoff();\n      }\n\n      return;\n    }\n\n    const pc = this.mediaStream.version.pc;\n    const isIceDisconnected = pc && pc.iceConnectionState === 'disconnected';\n    const hasLowBytesWarning = this._monitor.hasActiveWarning('bytesSent', 'min')\n      || this._monitor.hasActiveWarning('bytesReceived', 'min');\n\n    // Only certain conditions can trigger media reconnection\n    if ((type === LowBytes && isIceDisconnected)\n      || (type === ConnectionDisconnected && hasLowBytesWarning)\n      || isEndOfIceCycle) {\n\n      const mediaReconnectionError = {\n        code: 53405,\n        message: 'Media connection failed.',\n        twilioError: new MediaErrors.ConnectionError(),\n      };\n      this._log.warn('ICE Connection disconnected.');\n      this._publisher.warn('connection', 'error', mediaReconnectionError, this);\n      this._publisher.info('connection', 'reconnecting', null, this);\n\n      this._mediaReconnectStartTime = Date.now();\n      this._status = Connection.State.Reconnecting;\n      this._mediaReconnectBackoff.reset();\n      this._mediaReconnectBackoff.backoff();\n\n      this.emit('reconnecting', mediaReconnectionError);\n    }\n  }\n\n  /**\n   * Called when media connection is restored\n   */\n  private _onMediaReconnected = (): void => {\n    // Only trigger once.\n    // This can trigger on pc.onIceConnectionChange and pc.onConnectionChange.\n    if (this._status !== Connection.State.Reconnecting) {\n      return;\n    }\n    this._log.info('ICE Connection reestablished.');\n    this._publisher.info('connection', 'reconnected', null, this);\n\n    this._status = Connection.State.Open;\n    this.emit('reconnected');\n  }\n\n  /**\n   * When we get a RINGING signal from PStream, update the {@link Connection} status.\n   * @param payload\n   */\n  private _onRinging = (payload: Record<string, any>): void => {\n    this._setCallSid(payload);\n\n    // If we're not in 'connecting' or 'ringing' state, this event was received out of order.\n    if (this._status !== Connection.State.Connecting && this._status !== Connection.State.Ringing) {\n      return;\n    }\n\n    const hasEarlyMedia = !!payload.sdp;\n    if (this.options.enableRingingState) {\n      this._status = Connection.State.Ringing;\n      this._publisher.info('connection', 'outgoing-ringing', { hasEarlyMedia }, this);\n      this.emit('ringing', hasEarlyMedia);\n    // answerOnBridge=false will send a 183, which we need to interpret as `answer` when\n    // the enableRingingState flag is disabled in order to maintain a non-breaking API from 1.4.24\n    } else if (hasEarlyMedia) {\n      this._onAnswer(payload);\n    }\n  }\n\n  /**\n   * Called each time StatsMonitor emits a sample.\n   * Emits stats event and batches the call stats metrics and sends them to Insights.\n   * @param sample\n   */\n  private _onRTCSample = (sample: RTCSample): void => {\n    const callMetrics: Connection.CallMetrics = {\n      ...sample,\n      inputVolume: this._latestInputVolume,\n      outputVolume: this._latestOutputVolume,\n    };\n\n    this._codec = callMetrics.codecName;\n\n    this._metricsSamples.push(callMetrics);\n    if (this._metricsSamples.length >= METRICS_BATCH_SIZE) {\n      this._publishMetrics();\n    }\n\n    this.emit('sample', sample);\n  }\n\n  /**\n   * Called when we receive a transportClose event from pstream.\n   * Re-emits the event.\n   */\n  private _onTransportClose = (): void => {\n    this._log.error('Received transportClose from pstream');\n    this.emit('transportClose');\n  }\n\n  /**\n   * Post an event to Endpoint Analytics indicating that the end user\n   *   has ignored a request for feedback.\n   */\n  private _postFeedbackDeclined(): Promise<void> {\n    return this._publisher.info('feedback', 'received-none', null, this, true);\n  }\n\n  /**\n   * Publish the current set of queued metrics samples to Insights.\n   */\n  private _publishMetrics(): void {\n    if (this._metricsSamples.length === 0) {\n      return;\n    }\n\n    this._publisher.postMetrics(\n      'quality-metrics-samples', 'metrics-sample', this._metricsSamples.splice(0), this._createMetricPayload(), this,\n    ).catch((e: any) => {\n      this._log.warn('Unable to post metrics to Insights. Received error:', e);\n    });\n  }\n\n  /**\n   * Re-emit an StatsMonitor warning as a {@link Connection}.warning or .warning-cleared event.\n   * @param warningData\n   * @param wasCleared - Whether this is a -cleared or -raised event.\n   */\n  private _reemitWarning = (warningData: Record<string, any>, wasCleared?: boolean): void => {\n    const groupPrefix = /^audio/.test(warningData.name) ?\n      'audio-level-' : 'network-quality-';\n\n    const warningPrefix = WARNING_PREFIXES[warningData.threshold.name];\n\n    /**\n     * NOTE: There are two \"packet-loss\" warnings: `high-packet-loss` and\n     * `high-packets-lost-fraction`, so in this case we need to use a different\n     * `WARNING_NAME` mapping.\n     */\n    let warningName: string | undefined;\n    if (warningData.name in MULTIPLE_THRESHOLD_WARNING_NAMES) {\n      warningName = MULTIPLE_THRESHOLD_WARNING_NAMES[warningData.name][warningData.threshold.name];\n    } else if (warningData.name in WARNING_NAMES) {\n      warningName = WARNING_NAMES[warningData.name];\n    }\n\n    const warning: string = warningPrefix + warningName;\n\n    this._emitWarning(groupPrefix, warning, warningData.threshold.value,\n                      warningData.values || warningData.value, wasCleared, warningData);\n  }\n\n  /**\n   * Re-emit an StatsMonitor warning-cleared as a .warning-cleared event.\n   * @param warningData\n   */\n  private _reemitWarningCleared = (warningData: Record<string, any>): void => {\n    this._reemitWarning(warningData, true);\n  }\n\n  /**\n   * Set the CallSid\n   * @param payload\n   */\n  private _setCallSid(payload: Record<string, string>): void {\n    const callSid = payload.callsid;\n    if (!callSid) { return; }\n\n    this.parameters.CallSid = callSid;\n    this.mediaStream.callSid = callSid;\n  }\n}\n\nnamespace Connection {\n  /**\n   * Emitted when the {@link Connection} is accepted.\n   * @param connection - The {@link Connection}.\n   * @example `connection.on('accept', connection => { })`\n   * @event\n   */\n  declare function acceptEvent(connection: Connection): void;\n\n  /**\n   * Emitted when the {@link Connection} is canceled.\n   * @example `connection.on('cancel', () => { })`\n   * @event\n   */\n  declare function cancelEvent(): void;\n\n  /**\n   * Emitted when the {@link Connection} is disconnected.\n   * @param connection - The {@link Connection}.\n   * @example `connection.on('disconnect', connection => { })`\n   * @event\n   */\n  declare function disconnectEvent(connection: Connection): void;\n\n  /**\n   * Emitted when the {@link Connection} receives an error.\n   * @param error\n   * @example `connection.on('error', error => { })`\n   * @event\n   */\n  declare function errorEvent(error: Connection.Error): void;\n\n  /**\n   * Emitted when the {@link Connection} is muted or unmuted.\n   * @param isMuted - Whether the {@link Connection} is muted.\n   * @param connection - The {@link Connection}.\n   * @example `connection.on('mute', (isMuted, connection) => { })`\n   * @event\n   */\n  declare function muteEvent(isMuted: boolean, connection: Connection): void;\n\n  /**\n   * Emitted when the {@link Connection} is rejected.\n   * @param connection - The {@link Connection}.\n   * @example `connection.on('reject', connection => { })`\n   * @event\n   */\n  declare function rejectEvent(connection: Connection): void;\n\n  /**\n   * Emitted every 50ms with the current input and output volumes, as a percentage of maximum\n   * volume, between -100dB and -30dB. Represented by a floating point number.\n   * @param inputVolume - A floating point number between 0.0 and 1.0 inclusive.\n   * @param outputVolume - A floating point number between 0.0 and 1.0 inclusive.\n   * @example `connection.on('volume', (inputVolume, outputVolume) => { })`\n   * @event\n   */\n  declare function volumeEvent(inputVolume: number, outputVolume: number): void;\n\n  /**\n   * Emitted when the {@link Connection} gets a webrtc sample object.\n   * This event is published every second.\n   * @param sample\n   * @example `connection.on('sample', sample => { })`\n   * @event\n   */\n  declare function sampleEvent(sample: RTCSample): void;\n\n  /**\n   * Possible states of the {@link Connection}.\n   */\n  export enum State {\n    Closed = 'closed',\n    Connecting = 'connecting',\n    Open = 'open',\n    Pending = 'pending',\n    Reconnecting = 'reconnecting',\n    Ringing = 'ringing',\n  }\n\n  /**\n   * Different issues that may have been experienced during a call, that can be\n   * reported to Twilio Insights via {@link Connection}.postFeedback().\n   */\n  export enum FeedbackIssue {\n    AudioLatency = 'audio-latency',\n    ChoppyAudio = 'choppy-audio',\n    DroppedCall = 'dropped-call',\n    Echo = 'echo',\n    NoisyCall = 'noisy-call',\n    OneWayAudio = 'one-way-audio',\n  }\n\n  /**\n   * A rating of call quality experienced during a call, to be reported to Twilio Insights\n   * via {@link Connection}.postFeedback().\n   */\n  export enum FeedbackScore {\n    One = 1,\n    Two,\n    Three,\n    Four,\n    Five,\n  }\n\n  /**\n   * The directionality of the {@link Connection}, whether incoming or outgoing.\n   */\n  export enum CallDirection {\n    Incoming = 'INCOMING',\n    Outgoing = 'OUTGOING',\n  }\n\n  /**\n   * Valid audio codecs to use for the media connection.\n   */\n  export enum Codec {\n    Opus = 'opus',\n    PCMU = 'pcmu',\n  }\n\n  /**\n   * Possible ICE Gathering failures\n   */\n  export enum IceGatheringFailureReason {\n    None = 'none',\n    Timeout = 'timeout',\n  }\n\n  /**\n   * Possible media failures\n   */\n  export enum MediaFailure {\n    ConnectionDisconnected = 'ConnectionDisconnected',\n    ConnectionFailed = 'ConnectionFailed',\n    IceGatheringFailed = 'IceGatheringFailed',\n    LowBytes = 'LowBytes',\n  }\n\n  /**\n   * The error format used by errors emitted from {@link Connection}.\n   */\n  export interface Error {\n    /**\n     * Error code\n     */\n    code: number;\n\n    /**\n     * Reference to the {@link Connection}\n     */\n    connection: Connection;\n\n    /**\n     * The info object from rtc/peerconnection. May contain code and message (duplicated here).\n     */\n    info: { code?: number, message?: string };\n\n    /**\n     * Error message\n     */\n    message: string;\n\n    /**\n     * Twilio Voice related error\n     */\n    twilioError?: TwilioError;\n  }\n\n  /**\n   * A CallerInfo provides caller verification information.\n   */\n  export interface CallerInfo {\n    /**\n     * Whether or not the caller's phone number has been verified by\n     * Twilio using SHAKEN/STIR validation. True if the caller has\n     * been validated at level 'A', false if the caller has been\n     * verified at any lower level or has failed validation.\n     */\n    isVerified: boolean;\n  }\n\n  /**\n   * Mandatory config options to be passed to the {@link Connection} constructor.\n   * @private\n   */\n  export interface Config {\n    /**\n     * An AudioHelper instance to be used for input/output devices.\n     */\n    audioHelper: IAudioHelper;\n\n    /**\n     * A method to use for getUserMedia.\n     */\n    getUserMedia: (constraints: MediaStreamConstraints) => Promise<MediaStream>;\n\n    /**\n     * Whether or not the browser uses unified-plan SDP by default.\n     */\n    isUnifiedPlanDefault: boolean;\n\n    /**\n     * The PStream instance to use for Twilio call signaling.\n     */\n    pstream: IPStream;\n\n    /**\n     * An EventPublisher instance to use for publishing events\n     */\n    publisher: IPublisher;\n\n    /**\n     * A Map of Sounds to play.\n     */\n    soundcache: Map<Device.SoundName, ISound>;\n  }\n\n  /**\n   * Options to be passed to the {@link Connection} constructor.\n   * @private\n   */\n  export interface Options {\n    /**\n     * Audio Constraints to pass to getUserMedia when making or accepting a Call.\n     * This is placed directly under `audio` of the MediaStreamConstraints object.\n     */\n    audioConstraints?: MediaTrackConstraints | boolean;\n\n    /**\n     * A method to call before Connection.accept is processed.\n     */\n    beforeAccept?: (connection: Connection) => void;\n\n    /**\n     * Custom format context parameters associated with this call.\n     */\n    callParameters?: Record<string, string>;\n\n    /**\n     * An ordered array of codec names, from most to least preferred.\n     */\n    codecPreferences?: Codec[];\n\n    /**\n     * A DialTone player, to play mock DTMF sounds.\n     */\n    dialtonePlayer?: DialtonePlayer;\n\n    /**\n     * Whether or not to enable DSCP.\n     */\n    dscp?: boolean;\n\n    /**\n     * Whether to automatically restart ICE when media connection fails\n     */\n    enableIceRestart?: boolean;\n\n    /**\n     * Whether the ringing state should be enabled.\n     */\n    enableRingingState?: boolean;\n\n    /**\n     * Experimental feature.\n     * Force Chrome's ICE agent to use aggressive nomination when selecting a candidate pair.\n     */\n    forceAggressiveIceNomination?: boolean;\n\n    /**\n     * The gateway currently connected to.\n     */\n    gateway?: string;\n\n    /**\n     * A method that returns the current input MediaStream set on {@link Device}.\n     */\n    getInputStream?: () => MediaStream;\n\n    /**\n     * A method that returns the current SinkIDs set on {@link Device}.\n     */\n    getSinkIds?: () => string[];\n\n    /**\n     * The maximum average audio bitrate to use, in bits per second (bps) based on\n     * [RFC-7587 7.1](https://tools.ietf.org/html/rfc7587#section-7.1). By default, the setting\n     * is not used. If you specify 0, then the setting is not used. Any positive integer is allowed,\n     * but values outside the range 6000 to 510000 are ignored and treated as 0. The recommended\n     * bitrate for speech is between 8000 and 40000 bps as noted in\n     * [RFC-7587 3.1.1](https://tools.ietf.org/html/rfc7587#section-3.1.1).\n     */\n    maxAverageBitrate?: number;\n\n    /**\n     * Custom MediaStream (PeerConnection) constructor. Overrides mediaStreamFactory (deprecated).\n     */\n    MediaStream?: IPeerConnection;\n\n    /**\n     * Custom MediaStream (PeerConnection) constructor (deprecated)\n     */\n    mediaStreamFactory?: IPeerConnection;\n\n    /**\n     * The offer SDP, if this is an incoming call.\n     */\n    offerSdp?: string | null;\n\n    /**\n     * Whether this is a preflight call or not\n     */\n    preflight?: boolean;\n\n    /**\n     * The Region currently connected to.\n     */\n    region?: string;\n\n    /**\n     * An RTCConfiguration to pass to the RTCPeerConnection constructor.\n     */\n    rtcConfiguration?: RTCConfiguration;\n\n    /**\n     * RTC Constraints to pass to getUserMedia when making or accepting a Call.\n     * The format of this object depends on browser.\n     */\n    rtcConstraints?: MediaStreamConstraints;\n\n    /**\n     * The region passed to {@link Device} on setup.\n     */\n    selectedRegion?: string;\n\n    /**\n     * Whether the disconnect sound should be played.\n     */\n    shouldPlayDisconnect?: () => boolean;\n\n    /**\n     * An override for the StatsMonitor dependency.\n     */\n    StatsMonitor?: new () => StatsMonitor;\n\n    /**\n     * TwiML params for the call. May be set for either outgoing or incoming calls.\n     */\n    twimlParams?: Record<string, any>;\n  }\n\n  /**\n   * Call metrics published to Insight Metrics.\n   * This include rtc samples and audio information.\n   * @private\n   */\n  export interface CallMetrics extends RTCSample {\n    /**\n     * Percentage of maximum volume, between 0.0 to 1.0, representing -100 to -30 dB.\n     */\n    inputVolume: number;\n\n    /**\n     * Percentage of maximum volume, between 0.0 to 1.0, representing -100 to -30 dB.\n     */\n    outputVolume: number;\n  }\n}\n\nfunction generateTempCallSid() {\n  return 'TJSxxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {\n    /* tslint:disable:no-bitwise */\n    const r = Math.random() * 16 | 0;\n    const v = c === 'x' ? r : (r & 0x3 | 0x8);\n    /* tslint:enable:no-bitwise */\n    return v.toString(16);\n  });\n}\n\nexport default Connection;\n"],"sourceRoot":""},"metadata":{},"sourceType":"script"}